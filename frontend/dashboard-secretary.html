<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דשבורד ניהול משימות - משרד עו"ד GH</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="shortcut icon" type="image/png" href="images/favicon.png">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="images/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="images/icon-192.png">

  <!-- Theme Colors -->
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="דשבורד GH">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --secondary-light: #34d399;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --success: #22c55e;

      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;

      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;

      --font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: var(--font-family);
      font-size: 16px;
      line-height: 1.6;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    body {
      padding: var(--space-4);
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: var(--space-6) var(--space-8);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-8);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='m36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      opacity: 0.1;
      z-index: 1;
    }

    .header-content {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .header-title { font-size: 2rem; font-weight: 700; margin-bottom: var(--space-1); }
    .header-subtitle { font-size: 1.1rem; opacity: 0.9; }
    .header-nav-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
    .header-nav-link:hover { color: white; }

    .header-stats { display: flex; gap: var(--space-6); flex-wrap: wrap; }
    .stat-item { text-align: center; min-width: 80px; }
    .stat-number { font-size: 1.8rem; font-weight: 700; display: block; }
    .stat-label { font-size: 0.9rem; opacity: 0.8; }

    /* Controls */
    .controls-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .control-group { display: flex; flex-direction: column; gap: var(--space-2); }
    .control-label { font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }

    .control-input {
      padding: var(--space-3);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      background: var(--bg-secondary);
      transition: all 0.2s ease;
      font-family: var(--font-family);
    }

    .control-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }

    .control-buttons { display: flex; gap: var(--space-3); flex-wrap: wrap; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
      font-family: var(--font-family);
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-primary); border-color: var(--primary); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: var(--space-1) var(--space-2); font-size: 0.8rem; }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-6);
      margin-bottom: var(--space-8);
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .stat-card.primary::before { background: var(--primary); }
    .stat-card.secondary::before { background: var(--secondary); }
    .stat-card.warning::before { background: var(--warning); }
    .stat-card.danger::before { background: var(--danger); }
    .stat-card.info::before { background: var(--info); }

    .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .stat-card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

    .stat-card-icon {
      width: 48px; height: 48px;
      border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: white;
    }

    .stat-card-icon.primary { background: var(--primary); }
    .stat-card-icon.secondary { background: var(--secondary); }
    .stat-card-icon.warning { background: var(--warning); }
    .stat-card-icon.danger { background: var(--danger); }
    .stat-card-icon.info { background: var(--info); }

    .stat-card-value { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); line-height: 1; margin-bottom: var(--space-2); }
    .stat-card-change { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: var(--space-1); }
    .stat-card-change.positive { color: var(--success); }
    .stat-card-change.negative { color: var(--danger); }
    .stat-card-change.neutral { color: var(--text-muted); }

    /* Charts */
    .charts-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
      margin-bottom: var(--space-8);
    }

    .chart-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }

    .chart-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-4); text-align: center; }
    .chart-container { position: relative; height: 300px; }

    /* Tasks Table */
    .tasks-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .tasks-header {
      background: var(--bg-primary);
      padding: var(--space-6);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .tasks-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
    .tasks-actions { display: flex; gap: var(--space-3); }

    .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }

    .tasks-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }

    .tasks-table th {
      background: var(--bg-primary);
      padding: var(--space-4);
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .tasks-table td {
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .tasks-table tr:hover { background: var(--bg-primary); }

    /* Status & Priority Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
    }

    .status-badge.pending { background: rgb(59 130 246 / 0.1); color: var(--primary); }
    .status-badge.in-progress { background: rgb(16 185 129 / 0.1); color: var(--secondary); }
    .status-badge.completed { background: rgb(34 197 94 / 0.1); color: var(--success); }
    .status-badge.returned { background: rgb(245 158 11 / 0.1); color: var(--warning); }
    .status-badge.cancelled { background: rgb(239 68 68 / 0.1); color: var(--danger); }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      font-size: 0.7rem;
      font-weight: 600;
      border-radius: var(--radius-sm);
    }

    .priority-badge.normal { background: rgb(148 163 184 / 0.1); color: var(--text-muted); }
    .priority-badge.urgent { background: rgb(245 158 11 / 0.1); color: var(--warning); }
    .priority-badge.critical { background: rgb(239 68 68 / 0.1); color: var(--danger); }

    .overdue-indicator { color: var(--danger); font-weight: 600; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: var(--space-4);
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-dialog {
      width: 100%;
      max-width: 480px;
      background-color: white;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s;
    }

    .modal-overlay.active .modal-dialog { transform: translateY(0); opacity: 1; }

    .modal-header {
      padding: var(--space-5) var(--space-6);
      color: white;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .modal-header.success-header { background: linear-gradient(135deg, #22c55e, #10b981); }
    .modal-header.warning-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .modal-header.info-header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }

    .modal-title { font-size: 1.1rem; font-weight: 600; }

    .modal-body { padding: var(--space-6); }

    .modal-body .form-group { margin-bottom: var(--space-5); }
    .modal-body .form-label { display: block; font-weight: 600; margin-bottom: var(--space-2); color: var(--text-primary); font-size: 0.9rem; }
    .modal-body .form-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-family: var(--font-family);
      transition: all 0.2s;
    }
    .modal-body .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1); }
    .modal-body textarea.form-input { min-height: 100px; resize: vertical; line-height: 1.5; }

    .modal-actions { display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6); }

    .task-detail-row { display: flex; gap: var(--space-2); padding: var(--space-2) 0; border-bottom: 1px solid var(--border-light); }
    .task-detail-label { font-weight: 600; color: var(--text-secondary); min-width: 100px; font-size: 0.9rem; }
    .task-detail-value { color: var(--text-primary); font-size: 0.9rem; flex: 1; }

    /* Toast */
    .toast {
      position: fixed;
      top: var(--space-6);
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-6);
      box-shadow: var(--shadow-xl);
      z-index: 99999;
      min-width: 300px;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .toast.success { border-right: 4px solid var(--success); }
    .toast.error { border-right: 4px solid var(--danger); }
    .toast.warning { border-right: 4px solid var(--warning); }
    .toast.info { border-right: 4px solid var(--info); }

    .toast-icon { font-size: 1.2rem; }
    .toast.success .toast-icon { color: var(--success); }
    .toast.error .toast-icon { color: var(--danger); }
    .toast.warning .toast-icon { color: var(--warning); }
    .toast.info .toast-icon { color: var(--info); }

    /* Loading & Empty */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--space-12);
      color: var(--text-muted);
    }

    .loading i { animation: spin 1s linear infinite; margin-left: var(--space-2); }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: var(--space-12); color: var(--text-muted); }
    .empty-state i { font-size: 3rem; margin-bottom: var(--space-4); opacity: 0.5; }

    /* Quick Actions */
    .quick-actions { position: fixed; bottom: var(--space-6); left: var(--space-6); z-index: 1000; }

    .quick-action-btn {
      width: 56px; height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      margin-bottom: var(--space-3);
    }

    .quick-action-btn:hover { transform: scale(1.1); background: var(--primary-dark); }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: var(--space-2); }
      .header { padding: var(--space-4); }
      .header-content { flex-direction: column; text-align: center; }
      .header-title { font-size: 1.5rem; }
      .header-stats { justify-content: center; gap: var(--space-4); }
      .controls-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; gap: var(--space-4); }
      .charts-section { grid-template-columns: 1fr; }
      .chart-container { height: 250px; }
      .tasks-header { flex-direction: column; align-items: stretch; }
      .tasks-actions { justify-content: center; }
      .btn { font-size: 0.8rem; padding: var(--space-2) var(--space-3); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div>
          <h1 class="header-title">דשבורד ניהול משימות</h1>
          <p class="header-subtitle">משרד עו"ד GH - מעקב וניתוח משימות בזמן אמת</p>
          <a href="index.html" class="header-nav-link"><i class="fas fa-plus-circle"></i> שליחת משימה חדשה</a>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <span class="stat-number" id="totalTasks">-</span>
            <span class="stat-label">סה"כ משימות</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="pendingTasks">-</span>
            <span class="stat-label">ממתינות</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="completedTasks">-</span>
            <span class="stat-label">הושלמו</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="overdueTasks">-</span>
            <span class="stat-label">פגות תוקף</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <section class="controls-section">
      <div class="controls-grid">
        <div class="control-group">
          <label class="control-label">סינון לפי משתמש</label>
          <select class="control-input" id="userFilter">
            <option value="">כל המשתמשים</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">סינון לפי סטטוס</label>
          <select class="control-input" id="statusFilter">
            <option value="">כל הסטטוסים</option>
            <option value="ממתינה">ממתינה</option>
            <option value="בביצוע">בביצוע</option>
            <option value="בוצע">בוצע</option>
            <option value="הוחזר להשלמה">הוחזר להשלמה</option>
            <option value="בוטל">בוטל</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">סינון לפי דחיפות</label>
          <select class="control-input" id="priorityFilter">
            <option value="">כל הדחיפויות</option>
            <option value="רגילה">רגילה</option>
            <option value="דחופה">דחופה</option>
            <option value="דחופה מאוד">דחופה מאוד</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">חיפוש חופשי</label>
          <input type="text" class="control-input" id="searchInput" placeholder="חפש במזהה, תיאור או משתמש...">
        </div>
      </div>
      <div class="control-buttons">
        <button class="btn btn-primary" onclick="loadTasks()">
          <i class="fas fa-sync-alt"></i> רענן נתונים
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
          <i class="fas fa-times"></i> נקה סינונים
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          <i class="fas fa-download"></i> ייצא לאקסל
        </button>
        <button class="btn btn-warning" onclick="showOverdueReport()">
          <i class="fas fa-exclamation-triangle"></i> דוח איחורים
        </button>
      </div>
    </section>

    <!-- Statistics Cards -->
    <section class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-card-header">
          <div class="stat-card-title">משימות פעילות</div>
          <div class="stat-card-icon primary"><i class="fas fa-tasks"></i></div>
        </div>
        <div class="stat-card-value" id="activeTasksCount">0</div>
        <div class="stat-card-change neutral"><i class="fas fa-minus"></i><span>ממתינות + בביצוע</span></div>
      </div>
      <div class="stat-card secondary">
        <div class="stat-card-header">
          <div class="stat-card-title">הושלמו השבוע</div>
          <div class="stat-card-icon secondary"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="stat-card-value" id="weeklyCompletedCount">0</div>
        <div class="stat-card-change positive"><i class="fas fa-arrow-up"></i><span>השלמות אחרונות</span></div>
      </div>
      <div class="stat-card warning">
        <div class="stat-card-header">
          <div class="stat-card-title">משימות דחופות</div>
          <div class="stat-card-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
        </div>
        <div class="stat-card-value" id="urgentTasksCount">0</div>
        <div class="stat-card-change negative"><i class="fas fa-arrow-down"></i><span>דורש טיפול מיידי</span></div>
      </div>
      <div class="stat-card danger">
        <div class="stat-card-header">
          <div class="stat-card-title">פגות תוקף</div>
          <div class="stat-card-icon danger"><i class="fas fa-clock"></i></div>
        </div>
        <div class="stat-card-value" id="overdueTasksCount">0</div>
        <div class="stat-card-change negative"><i class="fas fa-exclamation"></i><span>דורש טיפול מיידי</span></div>
      </div>
      <div class="stat-card info">
        <div class="stat-card-header">
          <div class="stat-card-title">אחוז השלמה</div>
          <div class="stat-card-icon info"><i class="fas fa-chart-pie"></i></div>
        </div>
        <div class="stat-card-value" id="completionRate">0%</div>
        <div class="stat-card-change positive"><i class="fas fa-arrow-up"></i><span>מגמה טובה</span></div>
      </div>
      <div class="stat-card secondary">
        <div class="stat-card-header">
          <div class="stat-card-title">זמן תגובה ממוצע</div>
          <div class="stat-card-icon secondary"><i class="fas fa-stopwatch"></i></div>
        </div>
        <div class="stat-card-value" id="averageResponseTime">0h</div>
        <div class="stat-card-change neutral"><i class="fas fa-clock"></i><span>יעד: תחת 24h</span></div>
      </div>
    </section>

    <!-- Charts -->
    <section class="charts-section">
      <div class="chart-card">
        <h3 class="chart-title">התפלגות סטטוס משימות</h3>
        <div class="chart-container"><canvas id="statusChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">משימות לפי משתמש</h3>
        <div class="chart-container"><canvas id="userChart"></canvas></div>
      </div>
    </section>

    <!-- Tasks Table -->
    <section class="tasks-section">
      <div class="tasks-header">
        <h2 class="tasks-title">רשימת משימות</h2>
        <div class="tasks-actions">
          <a href="index.html" class="btn btn-primary"><i class="fas fa-plus"></i> משימה חדשה</a>
          <button class="btn btn-secondary" onclick="toggleCompletedTasks()">
            <i class="fas fa-eye" id="toggleCompletedIcon"></i> <span id="toggleCompletedText">הסתר הושלמו</span>
          </button>
        </div>
      </div>
      <div class="table-container">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>מזהה</th>
              <th>תאריך</th>
              <th>מבקש</th>
              <th>תיאור</th>
              <th>קטגוריה</th>
              <th>דחיפות</th>
              <th>תאריך יעד</th>
              <th>סטטוס</th>
              <th>איחור</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody">
            <tr>
              <td colspan="10" class="loading">
                <i class="fas fa-spinner fa-spin"></i> טוען משימות...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="quick-action-btn" title="רענן נתונים" onclick="loadTasks()"><i class="fas fa-sync-alt"></i></button>
    <a href="index.html" class="quick-action-btn" title="משימה חדשה" style="text-decoration:none;"><i class="fas fa-plus"></i></a>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="toast-icon fas fa-info-circle" id="toastIcon"></i>
    <div id="toastMessage"></div>
  </div>

  <!-- Modal: פרטי משימה -->
  <div class="modal-overlay" id="taskDetailModal">
    <div class="modal-dialog">
      <div class="modal-header info-header">
        <i class="fas fa-info-circle"></i>
        <div class="modal-title">פרטי משימה</div>
      </div>
      <div class="modal-body" id="taskDetailBody"></div>
    </div>
  </div>

  <!-- Modal: סימון כבוצע -->
  <div class="modal-overlay" id="completeModal">
    <div class="modal-dialog">
      <div class="modal-header success-header">
        <i class="fas fa-check-circle"></i>
        <div class="modal-title">סימון משימה כבוצעה</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
          משימה: <strong id="completeTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">פרטי ביצוע (חובה)</label>
          <textarea class="form-input" id="completionDetails" placeholder="תאר מה בוצע ואיך..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('completeModal')">ביטול</button>
          <button class="btn btn-success" id="confirmCompleteBtn"><i class="fas fa-check"></i> סמן כבוצע</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: החזרת משימה -->
  <div class="modal-overlay" id="returnModal">
    <div class="modal-dialog">
      <div class="modal-header warning-header">
        <i class="fas fa-undo"></i>
        <div class="modal-title">החזרת משימה למבקש</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
          משימה: <strong id="returnTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">סיבת ההחזרה (חובה)</label>
          <textarea class="form-input" id="returnReason" placeholder="מה חסר או לא ברור? מה המבקש צריך להשלים?"></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('returnModal')">ביטול</button>
          <button class="btn btn-warning" id="confirmReturnBtn"><i class="fas fa-undo"></i> החזר למבקש</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: דוח איחורים -->
  <div class="modal-overlay" id="overdueModal">
    <div class="modal-dialog" style="max-width: 600px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="modal-title">דוח משימות באיחור</div>
      </div>
      <div class="modal-body" id="overdueBody"></div>
    </div>
  </div>

  <script>
    // ============================================
    // Google Apps Script URL
    // ============================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4_TYPbCtA8KPKdANLBCFLDWyIIiBQMTzq6c02SyI9ZT7Xg2nMFUF3fV3msBecr8cI/exec';

    let allTasks = [];
    let filteredTasks = [];
    let showCompleted = true;
    let charts = {};

    const USERS = [
      'חיים', 'גיא', 'רועי', 'שחר', 'עוזי', 'אורי', 'ראיד', 'מרווה', 'מירי', 'שני', 'נטליה', 'מריה'
    ];

    // ============================================
    // Init
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
      loadTasks();
      setupEventListeners();
      initializeCharts();
    });

    function initializePage() {
      const userFilter = document.getElementById('userFilter');
      USERS.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        userFilter.appendChild(option);
      });

      // Auto refresh every 5 minutes
      setInterval(loadTasks, 300000);
    }

    function setupEventListeners() {
      document.getElementById('userFilter').addEventListener('change', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('priorityFilter').addEventListener('change', applyFilters);
      document.getElementById('searchInput').addEventListener('input', applyFilters);

      // Close modals on overlay click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) this.classList.remove('active');
        });
      });

      // Escape key closes modals
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
      });
    }

    // ============================================
    // Load Tasks (POST with action)
    // ============================================
    async function loadTasks() {
      try {
        showLoading(true);

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=getAllTasks'
        });

        const data = await response.json();

        if (data.status === 'success') {
          allTasks = data.tasks || [];
          updateStatistics();
          applyFilters();
          updateCharts();
          showToast('הנתונים עודכנו בהצלחה', 'success');
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        showToast('שגיאה בטעינת הנתונים: ' + error.message, 'error');
        showErrorState();
      } finally {
        showLoading(false);
      }
    }

    // ============================================
    // Statistics
    // ============================================
    function updateStatistics() {
      const total = allTasks.length;
      const pending = allTasks.filter(t => t.status === 'ממתינה' || t.status === 'בביצוע').length;
      const completed = allTasks.filter(t => t.status === 'בוצע').length;
      const urgent = allTasks.filter(t => t.priority === 'דחופה' || t.priority === 'דחופה מאוד').length;

      const today = new Date();
      const overdue = allTasks.filter(t => {
        if (!t.dueDate || t.status === 'בוצע' || t.status === 'בוטל') return false;
        return new Date(t.dueDate) < today;
      }).length;

      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      const weeklyCompleted = allTasks.filter(t => {
        if (t.status !== 'בוצע' || !t.completionDate) return false;
        return new Date(t.completionDate) >= weekAgo;
      }).length;

      const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

      document.getElementById('totalTasks').textContent = total;
      document.getElementById('pendingTasks').textContent = pending;
      document.getElementById('completedTasks').textContent = completed;
      document.getElementById('overdueTasks').textContent = overdue;
      document.getElementById('activeTasksCount').textContent = pending;
      document.getElementById('weeklyCompletedCount').textContent = weeklyCompleted;
      document.getElementById('urgentTasksCount').textContent = urgent;
      document.getElementById('overdueTasksCount').textContent = overdue;
      document.getElementById('completionRate').textContent = completionRate + '%';
      document.getElementById('averageResponseTime').textContent = calculateAverageResponseTime();
    }

    function calculateAverageResponseTime() {
      const completedTasks = allTasks.filter(t => t.status === 'בוצע' && t.completionDate);
      if (completedTasks.length === 0) return '0h';

      let totalHours = 0;
      completedTasks.forEach(task => {
        const created = new Date(task.date + ' ' + (task.time || '00:00'));
        const done = new Date(task.completionDate + ' ' + (task.completionTime || '23:59'));
        totalHours += (done - created) / (1000 * 60 * 60);
      });

      const avgHours = Math.round(totalHours / completedTasks.length);
      return avgHours + 'h';
    }

    // ============================================
    // Filters
    // ============================================
    function applyFilters() {
      const userFilter = document.getElementById('userFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();

      filteredTasks = allTasks.filter(task => {
        if (userFilter && task.requester !== userFilter) return false;
        if (statusFilter && task.status !== statusFilter) return false;
        if (priorityFilter && task.priority !== priorityFilter) return false;
        if (!showCompleted && task.status === 'בוצע') return false;

        if (searchQuery) {
          const searchFields = [task.id, task.description, task.requester, task.category].join(' ').toLowerCase();
          if (!searchFields.includes(searchQuery)) return false;
        }

        return true;
      });

      renderTasksTable();
    }

    function clearFilters() {
      document.getElementById('userFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('priorityFilter').value = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      showToast('הסינונים נוקו', 'info');
    }

    function toggleCompletedTasks() {
      showCompleted = !showCompleted;
      document.getElementById('toggleCompletedIcon').className = showCompleted ? 'fas fa-eye-slash' : 'fas fa-eye';
      document.getElementById('toggleCompletedText').textContent = showCompleted ? 'הסתר הושלמו' : 'הצג הושלמו';
      applyFilters();
      showToast(showCompleted ? 'מציג את כל המשימות' : 'מסתיר משימות שהושלמו', 'info');
    }

    // ============================================
    // Render Table
    // ============================================
    function renderTasksTable() {
      const tbody = document.getElementById('tasksTableBody');

      if (filteredTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><i class="fas fa-search"></i><p>לא נמצאו משימות התואמות לסינון</p></td></tr>';
        return;
      }

      filteredTasks.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
        const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
        return dateB - dateA;
      });

      tbody.innerHTML = filteredTasks.map(task => {
        const overdue = isTaskOverdue(task);
        const delayDays = getDelayDays(task);
        const descShort = (task.description || '').substring(0, 50);
        const descFull = task.description || '';

        return `
          <tr>
            <td><code>${task.id || 'N/A'}</code></td>
            <td>${formatDate(task.date)}</td>
            <td><strong>${task.requester || 'לא ידוע'}</strong></td>
            <td>
              <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(descFull)}">
                ${escapeHtml(descShort)}${descFull.length > 50 ? '...' : ''}
              </div>
            </td>
            <td>${task.category || 'אחר'}</td>
            <td>${getPriorityBadge(task.priority)}</td>
            <td>${formatDate(task.dueDate)}</td>
            <td>${getStatusBadge(task.status)}</td>
            <td>${overdue ? '<span class="overdue-indicator">' + delayDays + ' ימים</span>' : '<span style="color:var(--text-muted)">-</span>'}</td>
            <td>
              <div style="display:flex;gap:4px;flex-wrap:wrap;">
                <button class="btn btn-sm btn-secondary" onclick="viewTaskDetails('${task.id}')" title="פרטים"><i class="fas fa-eye"></i></button>
                ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="btn btn-sm btn-success" onclick="openCompleteModal(\'' + task.id + '\')" title="סמן כבוצע"><i class="fas fa-check"></i></button>' : ''}
                ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="btn btn-sm btn-warning" onclick="openReturnModal(\'' + task.id + '\')" title="החזר למבקש"><i class="fas fa-undo"></i></button>' : ''}
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // ============================================
    // Helper Functions
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) { return dateStr; }
    }

    function getStatusBadge(status) {
      const map = { 'ממתינה': 'pending', 'בביצוע': 'in-progress', 'בוצע': 'completed', 'הוחזר להשלמה': 'returned', 'בוטל': 'cancelled' };
      const icons = { 'pending': 'clock', 'in-progress': 'play', 'completed': 'check', 'returned': 'undo', 'cancelled': 'times' };
      const cls = map[status] || 'pending';
      return '<span class="status-badge ' + cls + '"><i class="fas fa-' + (icons[cls] || 'clock') + '"></i> ' + (status || 'ממתינה') + '</span>';
    }

    function getPriorityBadge(priority) {
      const map = { 'רגילה': 'normal', 'דחופה': 'urgent', 'דחופה מאוד': 'critical' };
      const icons = { 'normal': 'minus', 'urgent': 'exclamation', 'critical': 'exclamation-triangle' };
      const cls = map[priority] || 'normal';
      return '<span class="priority-badge ' + cls + '"><i class="fas fa-' + (icons[cls] || 'minus') + '"></i> ' + (priority || 'רגילה') + '</span>';
    }

    function isTaskOverdue(task) {
      if (!task.dueDate || task.status === 'בוצע' || task.status === 'בוטל') return false;
      return new Date(task.dueDate) < new Date();
    }

    function getDelayDays(task) {
      if (!isTaskOverdue(task)) return 0;
      return Math.ceil((new Date() - new Date(task.dueDate)) / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // Modal Functions
    // ============================================
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function viewTaskDetails(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const body = document.getElementById('taskDetailBody');
      body.innerHTML = `
        <div class="task-detail-row"><div class="task-detail-label">מזהה:</div><div class="task-detail-value"><code>${task.id}</code></div></div>
        <div class="task-detail-row"><div class="task-detail-label">מבקש:</div><div class="task-detail-value">${task.requester || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">אימייל:</div><div class="task-detail-value">${task.requesterEmail || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">קטגוריה:</div><div class="task-detail-value">${task.category || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">דחיפות:</div><div class="task-detail-value">${getPriorityBadge(task.priority)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יעד:</div><div class="task-detail-value">${formatDate(task.dueDate)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">סטטוס:</div><div class="task-detail-value">${getStatusBadge(task.status)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יצירה:</div><div class="task-detail-value">${formatDate(task.date)} ${task.time || ''}</div></div>
        ${task.completionDate ? '<div class="task-detail-row"><div class="task-detail-label">תאריך השלמה:</div><div class="task-detail-value">' + formatDate(task.completionDate) + '</div></div>' : ''}
        ${task.completionDetails ? '<div class="task-detail-row"><div class="task-detail-label">פרטי ביצוע:</div><div class="task-detail-value">' + escapeHtml(task.completionDetails) + '</div></div>' : ''}
        ${task.attachments ? '<div class="task-detail-row"><div class="task-detail-label">קבצים:</div><div class="task-detail-value"><a href="' + task.attachments + '" target="_blank" rel="noopener">צפה בקבצים</a></div></div>' : ''}
        <div style="margin-top:var(--space-4);">
          <div class="form-label">תיאור המשימה:</div>
          <div style="background:var(--bg-primary);padding:var(--space-4);border-radius:var(--radius-md);line-height:1.6;white-space:pre-wrap;">${escapeHtml(task.description || '-')}</div>
        </div>
        ${task.secretaryNotes ? '<div style="margin-top:var(--space-4);"><div class="form-label">הערות מזכירה:</div><div style="background:#fff3cd;padding:var(--space-4);border-radius:var(--radius-md);line-height:1.6;">' + escapeHtml(task.secretaryNotes) + '</div></div>' : ''}
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('taskDetailModal')">סגור</button>
        </div>
      `;
      document.getElementById('taskDetailModal').classList.add('active');
    }

    // Mark as completed
    function openCompleteModal(taskId) {
      document.getElementById('completeTaskId').textContent = taskId;
      document.getElementById('completionDetails').value = '';
      document.getElementById('completeModal').classList.add('active');

      document.getElementById('confirmCompleteBtn').onclick = function() {
        const details = document.getElementById('completionDetails').value.trim();
        if (!details) {
          showToast('חובה להזין פרטי ביצוע', 'warning');
          document.getElementById('completionDetails').focus();
          return;
        }
        closeModal('completeModal');
        markAsCompleted(taskId, details);
      };

      setTimeout(() => document.getElementById('completionDetails').focus(), 300);
    }

    async function markAsCompleted(taskId, details) {
      try {
        showToast('מעדכן משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=markTaskCompleted&taskId=${encodeURIComponent(taskId)}&row=${task.row}&details=${encodeURIComponent(details)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה סומנה כבוצעת בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error marking as completed:', error);
        showToast('שגיאה בעדכון המשימה: ' + error.message, 'error');
      }
    }

    // Return task
    function openReturnModal(taskId) {
      document.getElementById('returnTaskId').textContent = taskId;
      document.getElementById('returnReason').value = '';
      document.getElementById('returnModal').classList.add('active');

      document.getElementById('confirmReturnBtn').onclick = function() {
        const reason = document.getElementById('returnReason').value.trim();
        if (!reason) {
          showToast('חובה להזין סיבת החזרה', 'warning');
          document.getElementById('returnReason').focus();
          return;
        }
        closeModal('returnModal');
        returnTask(taskId, reason);
      };

      setTimeout(() => document.getElementById('returnReason').focus(), 300);
    }

    async function returnTask(taskId, reason) {
      try {
        showToast('מחזיר משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=returnTask&taskId=${encodeURIComponent(taskId)}&row=${task.row}&reason=${encodeURIComponent(reason)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה הוחזרה למבקש בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error returning task:', error);
        showToast('שגיאה בהחזרת המשימה: ' + error.message, 'error');
      }
    }

    // Overdue report
    function showOverdueReport() {
      const overdueTasks = allTasks.filter(isTaskOverdue);

      const body = document.getElementById('overdueBody');

      if (overdueTasks.length === 0) {
        body.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle" style="color:var(--success);"></i><p>אין משימות שפג תוקפן</p></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal(\'overdueModal\')">סגור</button></div>';
      } else {
        overdueTasks.sort((a, b) => getDelayDays(b) - getDelayDays(a));
        let html = '<div style="margin-bottom:var(--space-4);color:var(--text-secondary);">' + overdueTasks.length + ' משימות באיחור</div>';
        overdueTasks.forEach(task => {
          html += `
            <div style="background:var(--bg-primary);padding:var(--space-3);border-radius:var(--radius-md);margin-bottom:var(--space-2);border-right:3px solid var(--danger);">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <strong>${task.requester}</strong> - <code>${task.id}</code>
                  <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:2px;">${escapeHtml((task.description || '').substring(0, 60))}...</div>
                </div>
                <span class="overdue-indicator">${getDelayDays(task)} ימים</span>
              </div>
            </div>`;
        });
        html += '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal(\'overdueModal\')">סגור</button></div>';
        body.innerHTML = html;
      }

      document.getElementById('overdueModal').classList.add('active');
    }

    // Export
    function exportToExcel() {
      const headers = ['מזהה', 'תאריך', 'מבקש', 'תיאור', 'קטגוריה', 'דחיפות', 'תאריך יעד', 'סטטוס', 'איחור'];
      const csvContent = [
        headers.join(','),
        ...filteredTasks.map(task => [
          task.id || '',
          formatDate(task.date),
          task.requester || '',
          '"' + (task.description || '').replace(/"/g, '""') + '"',
          task.category || '',
          task.priority || '',
          formatDate(task.dueDate),
          task.status || '',
          isTaskOverdue(task) ? getDelayDays(task) + ' ימים' : ''
        ].join(','))
      ].join('\n');

      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'משימות_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showToast('הקובץ הורד בהצלחה', 'success');
    }

    // ============================================
    // Charts
    // ============================================
    function initializeCharts() {
      charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['ממתינה', 'בביצוע', 'בוצע', 'הוחזר להשלמה', 'בוטל'],
          datasets: [{ data: [0,0,0,0,0], backgroundColor: ['#3b82f6','#10b981','#22c55e','#f59e0b','#ef4444'], borderWidth: 2, borderColor: '#ffffff' }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Rubik', size: 12 } } } }
        }
      });

      charts.user = new Chart(document.getElementById('userChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: USERS,
          datasets: [
            { label: 'פעילות', data: new Array(USERS.length).fill(0), backgroundColor: '#3b82f6', borderRadius: 4 },
            { label: 'הושלמו', data: new Array(USERS.length).fill(0), backgroundColor: '#22c55e', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'top', labels: { font: { family: 'Rubik', size: 12 } } } },
          scales: {
            y: { beginAtZero: true, ticks: { font: { family: 'Rubik' } } },
            x: { ticks: { font: { family: 'Rubik', size: 10 } } }
          }
        }
      });
    }

    function updateCharts() {
      const statusCounts = { 'ממתינה': 0, 'בביצוע': 0, 'בוצע': 0, 'הוחזר להשלמה': 0, 'בוטל': 0 };
      allTasks.forEach(t => { if (statusCounts.hasOwnProperty(t.status)) statusCounts[t.status]++; });
      charts.status.data.datasets[0].data = Object.values(statusCounts);
      charts.status.update();

      const userActive = new Array(USERS.length).fill(0);
      const userCompleted = new Array(USERS.length).fill(0);
      allTasks.forEach(t => {
        const idx = USERS.indexOf(t.requester);
        if (idx !== -1) { t.status === 'בוצע' ? userCompleted[idx]++ : userActive[idx]++; }
      });
      charts.user.data.datasets[0].data = userActive;
      charts.user.data.datasets[1].data = userCompleted;
      charts.user.update();
    }

    // ============================================
    // UI Helpers
    // ============================================
    function showLoading(show) {
      if (show) {
        document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="10" class="loading"><i class="fas fa-spinner fa-spin"></i> טוען נתונים...</td></tr>';
      }
    }

    function showErrorState() {
      document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="10" class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>שגיאה בטעינת הנתונים</p><button class="btn btn-primary" onclick="loadTasks()">נסה שוב</button></td></tr>';
    }

    let toastTimer;
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      const msgEl = document.getElementById('toastMessage');
      const iconEl = document.getElementById('toastIcon');

      const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
      iconEl.className = 'toast-icon fas ' + (icons[type] || icons.info);
      msgEl.textContent = message;
      toast.className = 'toast ' + (type || 'info') + ' show';

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 4000);
    }
  </script>
</body>
</html>
