<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דשבורד ניהול משימות - משרד עו"ד GH</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="shortcut icon" type="image/png" href="images/favicon.png">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="images/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="images/icon-192.png">

  <!-- Theme Colors -->
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="דשבורד GH">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --success: #22c55e;

      --bg-primary: #f0f2f5;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;

      /* Stripe-inspired blue-tinted shadows */
      --shadow-sm: 0 1px 3px rgba(18, 42, 66, 0.04), 0 0 0 1px rgba(18, 42, 66, 0.02);
      --shadow-md: 0 4px 12px rgba(18, 42, 66, 0.06), 0 0 0 1px rgba(18, 42, 66, 0.03);
      --shadow-lg: 0 8px 24px rgba(18, 42, 66, 0.08), 0 0 0 1px rgba(18, 42, 66, 0.04);

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;

      /* Grayscale tokens for premium cards */
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-150: #efefef;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-400: #a3a3a3;
      --gray-500: #737373;
      --gray-600: #525252;
      --gray-700: #404040;
      --gray-800: #262626;
      --gray-900: #171717;

      --sidebar-width: 280px;
      --topbar-height: 56px;

      --font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      font-family: var(--font-family);
      font-size: 15px;
      line-height: 1.5;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100%;
      -webkit-font-smoothing: antialiased;
    }

    body { display: flex; flex-direction: column; overflow: hidden; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ========== TOP BAR — white minimal (Stripe-style) ========== */
    .topbar {
      height: var(--topbar-height);
      background: #fff;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 100;
      border-bottom: 1px solid var(--gray-200);
      box-shadow: 0 1px 3px rgba(18, 42, 66, 0.04);
    }

    .topbar-right { display: flex; align-items: center; gap: 14px; }
    .topbar-logo { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.01em; color: var(--gray-900); }
    .topbar-subtitle { font-size: 0.75rem; color: var(--gray-400); }

    .topbar-left { display: flex; align-items: center; gap: 10px; }

    .topbar-btn {
      background: #fff;
      border: 1px solid var(--gray-200);
      color: var(--gray-700);
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-family);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .topbar-btn:hover { background: var(--gray-50); border-color: var(--gray-300); }

    .topbar-link {
      color: var(--gray-700);
      text-decoration: none;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      transition: all 0.15s;
    }

    .topbar-link:hover { background: var(--gray-50); border-color: var(--gray-300); color: var(--gray-900); }

    /* Refresh spin animation */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .topbar-btn.refreshing { pointer-events: none; opacity: 0.7; }
    .topbar-btn.refreshing i { animation: spin 0.8s linear infinite; }

    /* ========== LAYOUT ========== */
    .app-layout { display: flex; flex: 1; overflow: hidden; }

    /* ========== SIDEBAR (RIGHT) — Stripe-style collapsible ========== */
    .sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-left: 1px solid var(--gray-200);
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      box-shadow: -1px 0 3px rgba(18, 42, 66, 0.04);
      transition: width 0.3s ease;
    }

    /* Collapsed state — narrow strip showing dots + numbers */
    .sidebar.collapsed {
      width: 54px;
    }
    .sidebar.collapsed .sidebar-section-title,
    .sidebar.collapsed .stat-counter-label,
    .sidebar.collapsed .sidebar-filter,
    .sidebar.collapsed .sidebar-chart,
    .sidebar.collapsed .sidebar-footer {
      display: none;
    }
    .sidebar.collapsed .sidebar-section {
      padding: 10px 8px 6px;
    }
    .sidebar.collapsed .stat-counters {
      gap: 0;
    }
    .sidebar.collapsed .stat-counter {
      padding: 5px 6px;
      justify-content: center;
      gap: 6px;
    }
    .sidebar.collapsed .stat-counter-info {
      gap: 5px;
    }
    .sidebar.collapsed .stat-counter-dot {
      width: 5px;
      height: 5px;
    }
    .sidebar.collapsed .stat-counter-value {
      font-size: 0.7rem;
      min-width: auto;
    }

    /* Toggle tab — sticky at top of sidebar, always visible */
    .sidebar-toggle {
      position: sticky;
      top: 0;
      z-index: 10;
      width: 100%;
      padding: 10px 0;
      background: var(--primary);
      border: none;
      border-bottom: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #fff;
      font-size: 0.7rem;
      font-family: var(--font-family);
      font-weight: 500;
      transition: background 0.15s;
      flex-shrink: 0;
    }
    .sidebar-toggle:hover {
      background: var(--primary-dark);
    }
    .sidebar-toggle .toggle-label {
      font-size: 0.72rem;
    }
    .sidebar.collapsed .sidebar-toggle .toggle-label {
      display: none;
    }

    /* Sidebar sections */
    .sidebar-section {
      padding: 16px 16px 12px;
    }
    .sidebar-section + .sidebar-section {
      border-top: 1px solid var(--gray-150);
    }

    .sidebar-section-title {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray-400);
      margin-bottom: 10px;
    }

    /* Stat counters */
    .stat-counters { display: flex; flex-direction: column; gap: 2px; }

    .stat-counter {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s ease;
      border: none;
    }
    .stat-counter:hover { background: var(--gray-50); }
    .stat-counter.active { background: var(--gray-50); }
    .stat-counter.active .stat-counter-label { font-weight: 600; }

    .stat-counter-info { display: flex; align-items: center; gap: 8px; }
    .stat-counter-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .stat-counter-label { font-size: 0.8rem; font-weight: 450; color: var(--gray-700); }
    .stat-counter-value {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-500);
      min-width: 20px;
      text-align: center;
      padding: 0;
      border-radius: 0;
      background: none;
    }

    .dot-total { background: var(--gray-800); }
    .dot-pending { background: #2563eb; }
    .dot-in-progress { background: #8b5cf6; }
    .dot-completed { background: #16a34a; }
    .dot-returned { background: #d97706; }
    .dot-cancelled { background: #ef4444; }
    .dot-overdue { background: #dc2626; }
    .dot-urgent { background: #d97706; }

    /* Sidebar filters */
    .sidebar-filter { display: flex; flex-direction: column; gap: 6px; }

    .filter-select {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.8rem;
      background: #fff;
      color: var(--gray-700);
      font-family: var(--font-family);
      cursor: pointer;
      transition: border-color 0.15s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a3a3a3' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 10px center;
    }
    .filter-select:focus { outline: none; border-color: var(--gray-400); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }

    .sidebar-search {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.8rem;
      background: #fff;
      color: var(--gray-900);
      font-family: var(--font-family);
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .sidebar-search::placeholder { color: var(--gray-400); }
    .sidebar-search:focus { outline: none; border-color: var(--gray-400); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }

    .sidebar-btn {
      width: 100%;
      padding: 7px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font-family);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #fff;
      color: var(--gray-600);
      transition: all 0.15s ease;
    }
    .sidebar-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    .sidebar-btn-clear { background: #fff; color: var(--gray-600); border: 1px solid var(--gray-200); }
    .sidebar-btn-clear:hover { background: var(--gray-50); border-color: var(--gray-300); }

    .sidebar-btn-export {
      background: #fff;
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
    }
    .sidebar-btn-export:hover {
      background: #f0fdf4;
      border-color: #16a34a;
      color: #16a34a;
    }

    /* Sidebar export footer — gray bg like card footer */
    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--gray-150);
      background: var(--gray-50);
      margin-top: auto;
    }

    /* Mini chart */
    .sidebar-chart { height: 160px; position: relative; }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .main-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
    .task-count { font-size: 0.85rem; color: var(--text-muted); font-weight: 400; margin-right: 8px; }

    /* Status tabs (Active / Completed) */
    .status-tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 0;
    }

    .status-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      font-family: var(--font-family);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .status-tab:hover { color: var(--text-primary); }
    .status-tab.active { color: var(--gray-900); border-bottom-color: var(--gray-900); font-weight: 600; }

    .status-tab-count {
      background: var(--bg-primary);
      padding: 1px 7px;
      border-radius: 10px;
      font-size: 0.72rem;
      font-weight: 700;
    }

    .status-tab.active .status-tab-count {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .view-toggle { display: flex; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }

    .view-toggle-btn {
      padding: 6px 14px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.82rem;
      font-family: var(--font-family);
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.15s;
    }

    .view-toggle-btn.active { background: var(--gray-900); color: white; }
    .view-toggle-btn:not(.active):hover { background: var(--bg-primary); }

    /* ========== CARD VIEW ========== */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 1100px) {
      .cards-container { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 700px) {
      .cards-container { grid-template-columns: 1fr; }
    }

    /* Scale card content for larger screens */
    @media (min-width: 1400px) {
      .cards-container { gap: 20px; }
      .task-card-body { padding: 24px 24px 20px; gap: 14px; }
      .task-card-requester { font-size: 0.95rem; }
      .task-card-time { font-size: 0.75rem; }
      .task-card-desc { font-size: 0.9rem; -webkit-line-clamp: 3; }
      .task-card-bottom { padding: 14px 24px; }
      .task-card-meta { font-size: 0.78rem; }
      .card-action-btn-labeled { font-size: 0.75rem; padding: 6px 16px; }
    }

    @media (min-width: 1800px) {
      .cards-container { gap: 24px; }
      .task-card-body { padding: 28px 28px 22px; gap: 16px; }
      .task-card-requester { font-size: 1rem; }
      .task-card-time { font-size: 0.8rem; }
      .task-card-desc { font-size: 0.95rem; line-height: 1.7; }
      .task-card-bottom { padding: 16px 28px; }
      .task-card-meta { font-size: 0.82rem; gap: 20px; }
      .card-action-btn-labeled { font-size: 0.8rem; padding: 7px 18px; }
    }

    .task-card {
      background: var(--bg-card);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      position: relative;
      cursor: pointer;
      transition: box-shadow 0.25s ease, transform 0.25s ease;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .task-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .task-card-body {
      padding: 20px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .task-card-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .task-card-requester {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--gray-900);
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-card-requester i { display: none; }

    .task-card-time {
      font-size: 0.68rem;
      color: var(--gray-400);
    }

    .task-card-priority { flex-shrink: 0; }

    .task-card-desc {
      font-size: 0.82rem;
      color: var(--gray-600);
      line-height: 1.65;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .task-card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 0;
      padding: 12px 20px;
      border-top: 1px solid var(--gray-150);
      background: var(--gray-50);
    }

    .task-card-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.7rem;
      color: var(--gray-400);
    }

    .task-card-meta-item { display: flex; align-items: center; gap: 4px; }
    .task-card-meta-item.overdue-text { color: var(--danger); font-weight: 600; }

    .task-card-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .task-card:hover .task-card-actions { opacity: 1; }

    /* ========== TABLE VIEW ========== */
    .table-container { overflow-x: auto; background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); }

    .tasks-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }

    .tasks-table th {
      background: var(--bg-primary);
      padding: 10px 12px;
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 0.8rem;
    }

    .tasks-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .tasks-table tr:hover { background: var(--bg-primary); }

    /* ========== BADGES ========== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      font-size: 0.67rem;
      font-weight: 500;
      border-radius: 4px;
      background: var(--gray-100);
      color: var(--gray-500);
    }

    .status-badge.pending { background: var(--gray-100); color: var(--gray-500); }
    .status-badge.in-progress { background: var(--gray-100); color: var(--gray-600); }
    .status-badge.completed { background: #f0fdf4; color: #16a34a; }
    .status-badge.returned { background: #fffbeb; color: #d97706; }
    .status-badge.cancelled { background: var(--gray-100); color: var(--gray-400); }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 8px;
      font-size: 0.63rem;
      font-weight: 600;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: var(--gray-100);
      color: var(--gray-500);
    }

    .priority-badge.normal { background: var(--gray-100); color: var(--gray-500); }
    .priority-badge.urgent { background: #fffbeb; color: #d97706; }
    .priority-badge.critical { background: #dc2626; color: white; }

    .overdue-indicator { color: var(--danger); font-weight: 600; font-size: 0.8rem; }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s;
      padding: 16px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-dialog {
      width: 100%;
      max-width: 480px;
      background-color: white;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s;
    }

    .modal-overlay.active .modal-dialog { transform: translateY(0); opacity: 1; }

    .modal-header {
      padding: 16px 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-header.success-header { background: linear-gradient(135deg, #22c55e, #10b981); }
    .modal-header.warning-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .modal-header.info-header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }

    .modal-title { font-size: 1rem; font-weight: 600; }

    .modal-body { padding: 20px; }
    .modal-body .form-group { margin-bottom: 16px; }
    .modal-body .form-label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); font-size: 0.85rem; }

    .modal-body .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      font-family: var(--font-family);
      transition: all 0.2s;
    }

    .modal-body .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1); }
    .modal-body textarea.form-input { min-height: 90px; resize: vertical; line-height: 1.5; }

    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

    .task-detail-row { display: flex; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border-light); }
    .task-detail-label { font-weight: 600; color: var(--text-secondary); min-width: 90px; font-size: 0.82rem; }
    .task-detail-value { color: var(--text-primary); font-size: 0.82rem; flex: 1; }
    .task-detail-value a { color: var(--primary); text-decoration: none; }
    .task-detail-value a:hover { text-decoration: underline; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      font-size: 0.82rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
      white-space: nowrap;
      font-family: var(--font-family);
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-primary); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 5px 10px; font-size: 0.75rem; }

    /* ========== TOAST — slides from left (Stripe-style) ========== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 24px;
      transform: translateX(-120%);
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 12px 18px;
      box-shadow: 0 4px 12px rgba(18, 42, 66, 0.08), 0 0 0 1px rgba(18, 42, 66, 0.02);
      z-index: 99999;
      min-width: 260px;
      max-width: 380px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.82rem;
      color: var(--gray-700);
      opacity: 0;
      visibility: hidden;
      transition: transform 0.35s ease, opacity 0.35s ease, visibility 0.35s;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .toast.success { border-right: 3px solid #16a34a; }
    .toast.error { border-right: 3px solid #dc2626; }
    .toast.warning { border-right: 3px solid #d97706; }
    .toast.info { border-right: 3px solid var(--gray-400); }

    .toast-icon { font-size: 1rem; flex-shrink: 0; }
    .toast.success .toast-icon { color: #16a34a; }
    .toast.error .toast-icon { color: #dc2626; }
    .toast.warning .toast-icon { color: #d97706; }
    .toast.info .toast-icon { color: var(--gray-500); }

    /* ========== LOADING & EMPTY ========== */
    .loading-state {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px 20px;
      color: var(--text-muted);
      gap: 12px;
    }

    .loading-state i { font-size: 1.5rem; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.4; display: block; }

    /* ========== MOBILE SIDEBAR TOGGLE ========== */
    .sidebar-toggle-mobile {
      display: none;
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      font-size: 1.1rem;
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        top: var(--topbar-height);
        right: -300px;
        width: 280px;
        height: calc(100% - var(--topbar-height));
        z-index: 150;
        box-shadow: -4px 0 20px rgba(0,0,0,0.08);
        transition: right 0.3s ease;
      }

      .sidebar.collapsed { width: 280px; right: -300px; }
      .sidebar.collapsed .sidebar-section-title,
      .sidebar.collapsed .stat-counter-label,
      .sidebar.collapsed .sidebar-filter,
      .sidebar.collapsed .sidebar-chart,
      .sidebar.collapsed .sidebar-footer { display: block; }
      .sidebar.collapsed .sidebar-filter { display: flex; }
      .sidebar.collapsed .stat-counters { gap: 6px; }
      .sidebar.collapsed .stat-counter { padding: 7px 10px; justify-content: space-between; }
      .sidebar.collapsed .stat-counter-info { gap: 8px; }
      .sidebar.collapsed .stat-counter-dot { width: 6px; height: 6px; }
      .sidebar.collapsed .stat-counter-value { font-size: 0.75rem; }
      .sidebar.collapsed .sidebar-section { padding: 16px 16px 12px; }
      .sidebar.open { right: 0; width: 280px; }

      /* Hide desktop toggle tab on mobile */
      .sidebar-toggle { display: none; }

      .sidebar-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.25);
        z-index: 140;
        display: none;
      }

      .sidebar-overlay.show { display: block; }
      .sidebar-toggle-mobile { display: flex; }
    }

    @media (max-width: 600px) {
      .topbar { padding: 0 12px; }
      .topbar-subtitle { display: none; }
      .main-content { padding: 12px; }
      .task-card-body { padding: 14px; }
      .task-card-bottom { padding: 10px 14px; }
      .task-card-actions { opacity: 1; }
    }

    /* Hide view based on toggle */
    .view-hidden { display: none !important; }

    /* ========== AVATARS VIEW ========== */
    .avatars-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
      padding: 8px 0;
    }

    .user-avatar-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 22px 12px 16px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .user-avatar-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--gray-300);
      transform: translateY(-2px);
    }

    .user-avatar-card.active {
      border-color: var(--gray-900);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.06);
      background: var(--gray-50);
    }

    .user-avatar-card.no-tasks { opacity: 0.35; }
    .user-avatar-card.no-tasks:hover { opacity: 0.6; }

    .avatar-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 600;
      position: relative;
      flex-shrink: 0;
    }

    .avatar-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      line-height: 1.3;
    }

    .avatar-badges { display: flex; gap: 6px; align-items: center; }

    .avatar-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .avatar-badge-active { background: rgb(37 99 235 / 0.08); color: #2563eb; }
    .avatar-badge-returned { background: rgb(245 158 11 / 0.1); color: #b45309; }
    .avatar-badge-completed { background: rgb(34 197 94 / 0.08); color: #059669; }

    /* Notification bubble */
    .avatar-notification {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 22px;
      height: 22px;
      border-radius: 11px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      box-shadow: 0 2px 6px rgb(239 68 68 / 0.35);
      border: 2px solid var(--bg-card);
      animation: notifPulse 2s ease-in-out infinite;
    }

    .avatar-notification.warning {
      background: var(--warning);
      box-shadow: 0 2px 6px rgb(245 158 11 / 0.35);
      top: auto;
      bottom: -4px;
      right: -4px;
      animation: none;
    }

    .avatar-notification:empty { display: none; }

    @keyframes notifPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    /* Avatar colors */
    .avatar-color-0 { background: #bfdbfe; color: #1e40af; }
    .avatar-color-1 { background: #bbf7d0; color: #166534; }
    .avatar-color-2 { background: #fde68a; color: #92400e; }
    .avatar-color-3 { background: #fecaca; color: #991b1b; }
    .avatar-color-4 { background: #ddd6fe; color: #5b21b6; }
    .avatar-color-5 { background: #fbcfe8; color: #9d174d; }
    .avatar-color-6 { background: #a5f3fc; color: #155e75; }
    .avatar-color-7 { background: #99f6e4; color: #115e59; }
    .avatar-color-8 { background: #fed7aa; color: #9a3412; }
    .avatar-color-9 { background: #c7d2fe; color: #3730a3; }
    .avatar-color-10 { background: #e9d5ff; color: #6b21a8; }
    .avatar-color-11 { background: #e2e8f0; color: #334155; }

    /* Avatar tasks section */
    .avatar-tasks-section { margin-top: 8px; }

    .avatar-tasks-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 12px;
    }

    .avatar-tasks-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .avatar-tasks-title .avatar-circle { width: 36px; height: 36px; font-size: 0.85rem; }

    .avatar-tasks-close {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 4px 10px;
      cursor: pointer;
      font-family: var(--font-family);
      font-size: 0.78rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }

    .avatar-tasks-close:hover { background: var(--bg-primary); }

    @media (max-width: 600px) {
      .avatars-container {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 10px;
      }
      .avatar-circle { width: 52px; height: 52px; font-size: 1.1rem; }
      .user-avatar-card { padding: 14px 8px 12px; }
    }

    /* ========== ATTENTION BANNER ========== */
    .attention-banner {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 14px 18px;
      display: none;
    }

    .attention-banner.show { display: block; }

    .attention-banner-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--gray-700);
      margin-bottom: 10px;
    }

    .attention-items { display: flex; flex-wrap: wrap; gap: 6px; }

    .attention-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--gray-200);
      background: #fff;
      font-family: var(--font-family);
    }

    .attention-item:hover { border-color: var(--gray-300); }

    .attention-item.overdue-item { color: #dc2626; }
    .attention-item.overdue-item:hover { background: #fef2f2; border-color: #fecaca; }

    .attention-item.returned-item { color: #b45309; }
    .attention-item.returned-item:hover { background: #fffbeb; border-color: #fde68a; }

    .attention-item.urgent-item { color: #991b1b; }
    .attention-item.urgent-item:hover { background: #fef2f2; border-color: #fecaca; }

    .attention-item-count {
      background: var(--gray-100);
      border-radius: 4px;
      padding: 1px 6px;
      font-size: 0.72rem;
      font-weight: 700;
    }

    /* ========== CARD STATUS COLORS ========== */
    .task-card.status-pending { }
    .task-card.status-in-progress { }
    .task-card.status-returned { }
    .task-card.status-completed { opacity: 0.5; }
    .task-card.status-completed:hover { opacity: 0.75; }
    .task-card.status-cancelled { opacity: 0.35; }
    /* Overdue — red right bar + subtle badge */
    .task-card.task-card-overdue {
      border-right: 3px solid #dc2626;
    }

    /* ========== ACTION BUTTONS ON CARDS ========== */
    .card-action-btn-labeled {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 14px;
      border-radius: 6px;
      border: 1px solid var(--gray-200);
      background: #fff;
      cursor: pointer;
      font-size: 0.68rem;
      font-weight: 500;
      transition: all 0.15s ease;
      font-family: var(--font-family);
      white-space: nowrap;
      color: var(--gray-600);
    }

    .card-action-btn-labeled:hover {
      background: var(--gray-100);
    }

    .card-action-btn-labeled.btn-complete {
      color: var(--gray-600);
      border-color: var(--gray-200);
    }
    .card-action-btn-labeled.btn-complete:hover {
      background: #f0fdf4;
      border-color: #16a34a;
      color: #16a34a;
    }

    .card-action-btn-labeled.btn-return {
      color: var(--gray-600);
      border-color: var(--gray-200);
    }
    .card-action-btn-labeled.btn-return:hover {
      background: #fffbeb;
      border-color: #d97706;
      color: #d97706;
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-right">
      <div>
        <div class="topbar-logo">דשבורד משימות</div>
        <div class="topbar-subtitle">משרד עו"ד GH</div>
      </div>
    </div>
    <div class="topbar-left">
      <a href="index.html" class="topbar-link"><i class="fas fa-plus-circle"></i> שליחת משימה</a>
      <button class="topbar-btn" id="refreshBtn" onclick="loadTasks()" title="רענן נתונים"><i class="fas fa-sync-alt"></i> רענן</button>
      <span id="lastRefreshTime" style="font-size:0.7rem; color:var(--text-muted); margin-right:8px;" title="רענון אוטומטי כל דקה"></span>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="app-layout">
    <!-- SIDEBAR (right) -->
    <aside class="sidebar collapsed" id="sidebar">
      <!-- Toggle tab -->
      <button class="sidebar-toggle" id="sidebarToggleTab" onclick="toggleSidebarPanel()" title="פתח/סגור פאנל">
        <i class="fas fa-chevron-right" id="sidebarToggleIcon"></i>
        <span class="toggle-label">סגור פאנל</span>
      </button>
      <!-- Statistics Counters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">סטטיסטיקות</div>
        <div class="stat-counters">
          <div class="stat-counter" data-filter-status="" onclick="filterByStatus('')" id="counterAll">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-total"></span>
              <span class="stat-counter-label">סה"כ משימות</span>
            </div>
            <span class="stat-counter-value" id="statTotal">0</span>
          </div>
          <div class="stat-counter" data-filter-status="ממתינה" onclick="filterByStatus('ממתינה')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-pending"></span>
              <span class="stat-counter-label">ממתינות</span>
            </div>
            <span class="stat-counter-value" id="statPending">0</span>
          </div>
          <div class="stat-counter" data-filter-status="בביצוע" onclick="filterByStatus('בביצוע')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-in-progress"></span>
              <span class="stat-counter-label">בביצוע</span>
            </div>
            <span class="stat-counter-value" id="statInProgress">0</span>
          </div>
          <div class="stat-counter" data-filter-status="בוצע" onclick="filterByStatus('בוצע')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-completed"></span>
              <span class="stat-counter-label">הושלמו</span>
            </div>
            <span class="stat-counter-value" id="statCompleted">0</span>
          </div>
          <div class="stat-counter" data-filter-status="הוחזר להשלמה" onclick="filterByStatus('הוחזר להשלמה')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-returned"></span>
              <span class="stat-counter-label">הוחזרו</span>
            </div>
            <span class="stat-counter-value" id="statReturned">0</span>
          </div>
          <div class="stat-counter" data-filter-status="overdue" onclick="filterByOverdue()">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-overdue"></span>
              <span class="stat-counter-label">באיחור</span>
            </div>
            <span class="stat-counter-value" id="statOverdue">0</span>
          </div>
          <div class="stat-counter" data-filter-status="urgent" onclick="filterByUrgent()">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-urgent"></span>
              <span class="stat-counter-label">דחופות</span>
            </div>
            <span class="stat-counter-value" id="statUrgent">0</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">סינון</div>
        <div class="sidebar-filter">
          <input type="text" class="sidebar-search" id="searchInput" placeholder="חיפוש חופשי...">
          <select class="filter-select" id="userFilter">
            <option value="">כל המשתמשים</option>
          </select>
          <select class="filter-select" id="priorityFilter">
            <option value="">כל הדחיפויות</option>
            <option value="רגילה">רגילה</option>
            <option value="דחופה">דחופה</option>
            <option value="דחופה מאוד">דחופה מאוד</option>
          </select>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="font-size:0.72rem; color:var(--gray-500); white-space:nowrap;">מתאריך:</label>
            <input type="date" class="filter-select" id="dateFromFilter" value="2026-01-01" style="flex:1;">
          </div>
          <button class="sidebar-btn sidebar-btn-clear" onclick="clearFilters()"><i class="fas fa-times"></i> נקה סינונים</button>
          <button class="sidebar-btn sidebar-btn-clear" onclick="showAllTasks()" style="font-size:0.75rem;"><i class="fas fa-history"></i> הצג הכל</button>
        </div>
      </div>

      <!-- Chart -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">התפלגות סטטוס</div>
        <div class="sidebar-chart">
          <canvas id="statusChart"></canvas>
        </div>
      </div>

      <!-- Export — footer with gray bg -->
      <div class="sidebar-footer">
        <button class="sidebar-btn sidebar-btn-export" onclick="exportToExcel()"><i class="fas fa-download"></i> ייצא לאקסל</button>
      </div>
    </aside>

    <!-- MAIN CONTENT (left) -->
    <main class="main-content" id="mainContent">
      <!-- Attention Banner -->
      <div class="attention-banner" id="attentionBanner">
        <div class="attention-banner-title">
          <i class="fas fa-bell"></i> דורש תשומת לב
        </div>
        <div class="attention-items" id="attentionItems"></div>
      </div>

      <!-- Header row -->
      <div class="main-header">
        <div>
          <span class="main-title">משימות</span>
          <span class="task-count" id="taskCountLabel">0 משימות</span>
        </div>
        <div class="view-toggle">
          <button class="view-toggle-btn active" id="viewAvatars" onclick="setView('avatars')"><i class="fas fa-users"></i> צוות</button>
          <button class="view-toggle-btn" id="viewCards" onclick="setView('cards')"><i class="fas fa-th-large"></i> כרטיסים</button>
          <button class="view-toggle-btn" id="viewTable" onclick="setView('table')"><i class="fas fa-list"></i> טבלה</button>
        </div>
      </div>

      <!-- Status Tabs (Active / Completed) -->
      <div class="status-tabs">
        <button class="status-tab active" id="tabActive" onclick="setStatusTab('active')"><i class="fas fa-tasks"></i> פעילות <span class="status-tab-count" id="tabActiveCount">0</span></button>
        <button class="status-tab" id="tabCompleted" onclick="setStatusTab('completed')"><i class="fas fa-check-circle"></i> הושלמו <span class="status-tab-count" id="tabCompletedCount">0</span></button>
      </div>

      <!-- Avatars View -->
      <div id="avatarsView">
        <div class="avatars-container" id="avatarsGrid"></div>
        <div class="avatar-tasks-section" id="avatarTasksSection" style="display:none;">
          <div class="avatar-tasks-header">
            <div class="avatar-tasks-title" id="avatarTasksTitle"></div>
            <button class="avatar-tasks-close" onclick="clearAvatarSelection()"><i class="fas fa-times"></i> הצג הכל</button>
          </div>
          <div class="cards-container" id="avatarTasksCards"></div>
        </div>
      </div>

      <!-- Cards View -->
      <div class="cards-container view-hidden" id="cardsView"></div>

      <!-- Table View -->
      <div class="table-container view-hidden" id="tableView">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>תאריך</th>
              <th>מבקש</th>
              <th>תיאור</th>
              <th>דחיפות</th>
              <th>תאריך יעד</th>
              <th>סטטוס</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Mobile sidebar toggle -->
  <button class="sidebar-toggle-mobile" id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-filter"></i></button>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="toast-icon fas fa-info-circle" id="toastIcon"></i>
    <div id="toastMessage"></div>
  </div>

  <!-- Modal: פרטי משימה -->
  <div class="modal-overlay" id="taskDetailModal">
    <div class="modal-dialog" style="max-width: 520px;">
      <div class="modal-header info-header">
        <i class="fas fa-info-circle"></i>
        <div class="modal-title">פרטי משימה</div>
      </div>
      <div class="modal-body" id="taskDetailBody"></div>
    </div>
  </div>

  <!-- Modal: סימון כבוצע -->
  <div class="modal-overlay" id="completeModal">
    <div class="modal-dialog">
      <div class="modal-header success-header">
        <i class="fas fa-check-circle"></i>
        <div class="modal-title">סימון משימה כבוצעה</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 12px; color: var(--text-secondary);">
          משימה: <strong id="completeTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">פרטי ביצוע (חובה)</label>
          <textarea class="form-input" id="completionDetails" placeholder="תאר מה בוצע ואיך..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('completeModal')">ביטול</button>
          <button class="btn btn-success" id="confirmCompleteBtn"><i class="fas fa-check"></i> סמן כבוצע</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: החזרת משימה -->
  <div class="modal-overlay" id="returnModal">
    <div class="modal-dialog">
      <div class="modal-header warning-header">
        <i class="fas fa-undo"></i>
        <div class="modal-title">החזרת משימה למבקש</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 12px; color: var(--text-secondary);">
          משימה: <strong id="returnTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">סיבת ההחזרה (חובה)</label>
          <textarea class="form-input" id="returnReason" placeholder="מה חסר או לא ברור? מה המבקש צריך להשלים?"></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('returnModal')">ביטול</button>
          <button class="btn btn-warning" id="confirmReturnBtn"><i class="fas fa-undo"></i> החזר למבקש</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: דוח איחורים -->
  <div class="modal-overlay" id="overdueModal">
    <div class="modal-dialog" style="max-width: 600px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="modal-title">דוח משימות באיחור</div>
      </div>
      <div class="modal-body" id="overdueBody"></div>
    </div>
  </div>

  <script>
    // ============================================
    // Google Apps Script URL
    // ============================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz6K48cgRjNPtEtHvOX5HMAbY1UoUwZwDPAo3BXtSVqURqt0PWW2Ef0A7PSpnY9pnG-/exec';

    let allTasks = [];
    let filteredTasks = [];
    let currentView = 'avatars';
    let activeStatusFilter = '';
    let specialFilter = ''; // 'overdue' or 'urgent'
    let dateFromFilter = '2026-01-01'; // ברירת מחדל: מתחילת 2026
    let currentStatusTab = 'active'; // 'active' or 'completed'
    let charts = {};

    const USERS = [
      'חיים', 'גיא', 'רועי', 'שחר', 'עוזי', 'אורי', 'ראיד', 'מרווה', 'מירי', 'שני', 'נטליה', 'מריה'
    ];

    // ============================================
    // Init
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
      loadTasks();
      setupEventListeners();
      initializeCharts();
    });

    function initializePage() {
      const userFilter = document.getElementById('userFilter');
      USERS.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        userFilter.appendChild(option);
      });

      // רענון אוטומטי כל 60 שניות (שקט, בלי loading)
      setInterval(silentRefresh, 60000);

      // בקשת הרשאת התראות
      try {
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      } catch(e) {}
    }

    function setupEventListeners() {
      document.getElementById('userFilter').addEventListener('change', applyFilters);
      document.getElementById('priorityFilter').addEventListener('change', applyFilters);
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('dateFromFilter').addEventListener('change', function() {
        dateFromFilter = this.value || '';
        updateStatistics();
        applyFilters();
      });

      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) this.classList.remove('active');
        });
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
      });
    }

    // ============================================
    // Sidebar filter by status counter click
    // ============================================
    function filterByStatus(status) {
      specialFilter = '';
      activeStatusFilter = status;
      // Auto-switch tab based on status clicked
      if (status === 'בוצע') {
        currentStatusTab = 'completed';
        activeStatusFilter = ''; // No need to filter, the tab already shows completed
      } else if (status !== '' && status !== 'בוצע') {
        currentStatusTab = 'active';
      }
      document.getElementById('tabActive').classList.toggle('active', currentStatusTab === 'active');
      document.getElementById('tabCompleted').classList.toggle('active', currentStatusTab === 'completed');
      highlightActiveCounter(status);
      applyFilters();
    }

    function filterByOverdue() {
      activeStatusFilter = '';
      specialFilter = 'overdue';
      highlightActiveCounter('overdue');
      applyFilters();
    }

    function filterByUrgent() {
      activeStatusFilter = '';
      specialFilter = 'urgent';
      highlightActiveCounter('urgent');
      applyFilters();
    }

    function highlightActiveCounter(status) {
      document.querySelectorAll('.stat-counter').forEach(el => el.classList.remove('active'));
      const selector = status === 'overdue' || status === 'urgent'
        ? `.stat-counter[data-filter-status="${status}"]`
        : `.stat-counter[data-filter-status="${status}"]`;
      const el = document.querySelector(selector);
      if (el) el.classList.add('active');
    }

    // ============================================
    // View toggle
    // ============================================
    let selectedAvatarUser = '';

    function setView(view) {
      currentView = view;
      document.getElementById('viewAvatars').classList.toggle('active', view === 'avatars');
      document.getElementById('viewCards').classList.toggle('active', view === 'cards');
      document.getElementById('viewTable').classList.toggle('active', view === 'table');
      document.getElementById('avatarsView').classList.toggle('view-hidden', view !== 'avatars');
      document.getElementById('cardsView').classList.toggle('view-hidden', view !== 'cards');
      document.getElementById('tableView').classList.toggle('view-hidden', view !== 'table');
      if (view === 'avatars') renderAvatars();
    }

    // ============================================
    // Status Tab (Active / Completed)
    // ============================================
    function setStatusTab(tab) {
      currentStatusTab = tab;
      document.getElementById('tabActive').classList.toggle('active', tab === 'active');
      document.getElementById('tabCompleted').classList.toggle('active', tab === 'completed');
      // Clear special filters when switching tabs
      activeStatusFilter = '';
      specialFilter = '';
      document.querySelectorAll('.stat-counter').forEach(el => el.classList.remove('active'));
      applyFilters();
    }

    // ============================================
    // Sidebar — collapsible panel + mobile
    // ============================================
    function toggleSidebarPanel() {
      const sidebar = document.getElementById('sidebar');
      const icon = document.getElementById('sidebarToggleIcon');
      const label = sidebar.querySelector('.toggle-label');
      sidebar.classList.toggle('collapsed');
      const isCollapsed = sidebar.classList.contains('collapsed');
      icon.className = isCollapsed ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
      if (label) label.textContent = isCollapsed ? '' : 'סגור פאנל';
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('show');
    }

    // ============================================
    // Load Tasks
    // ============================================
    async function loadTasks() {
      const btn = document.getElementById('refreshBtn');
      if (btn) btn.classList.add('refreshing');
      try {
        showLoadingState();

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=getAllTasks'
        });

        const data = await response.json();

        if (data.status === 'success') {
          allTasks = data.tasks || [];
          updateStatistics();
          applyFilters();
          updateCharts();
          updateLastRefreshTime();
          showToast('הנתונים עודכנו בהצלחה', 'success');
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        showToast('שגיאה בטעינת הנתונים: ' + error.message, 'error');
        showErrorState();
      } finally {
        if (btn) btn.classList.remove('refreshing');
      }
    }

    /**
     * רענון שקט - בלי loading state, עם התראה על משימות חדשות
     */
    async function silentRefresh() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=getAllTasks'
        });

        const data = await response.json();

        if (data.status === 'success') {
          const newTasks = data.tasks || [];
          const oldCount = allTasks.length;
          const newCount = newTasks.length;

          allTasks = newTasks;
          updateStatistics();
          applyFilters();
          updateCharts();
          updateLastRefreshTime();

          // התראה על משימות חדשות
          if (newCount > oldCount) {
            const diff = newCount - oldCount;
            showToast('התקבלו ' + diff + ' משימות חדשות!', 'success');

            // צליל התראה (אם הדפדפן תומך)
            try {
              if (Notification.permission === 'granted') {
                new Notification('משימות חדשות', { body: 'התקבלו ' + diff + ' משימות חדשות', icon: 'images/icon-192.png' });
              } else if (Notification.permission !== 'denied') {
                Notification.requestPermission();
              }
            } catch(e) {}
          }
        }
      } catch (error) {
        console.error('Silent refresh error:', error);
      }
    }

    function updateLastRefreshTime() {
      const el = document.getElementById('lastRefreshTime');
      if (el) {
        const now = new Date();
        el.textContent = 'עודכן ' + now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
      }
    }

    // ============================================
    // Statistics (sidebar counters)
    // ============================================
    function updateStatistics() {
      // Filter by date first so stats match what the secretary sees
      const fromDate = dateFromFilter ? new Date(dateFromFilter) : null;
      const visibleTasks = fromDate ? allTasks.filter(t => {
        const taskDate = new Date(t.date);
        return isNaN(taskDate.getTime()) || taskDate >= fromDate;
      }) : allTasks;

      const activeTasks = visibleTasks.filter(t => t.status !== 'בוצע' && t.status !== 'בוטל');
      const completedTasks = visibleTasks.filter(t => t.status === 'בוצע' || t.status === 'בוטל');

      const pending = activeTasks.filter(t => t.status === 'ממתינה').length;
      const inProgress = activeTasks.filter(t => t.status === 'בביצוע').length;
      const completed = completedTasks.length;
      const returned = activeTasks.filter(t => t.status === 'הוחזר להשלמה').length;
      const urgent = activeTasks.filter(t => t.priority === 'דחופה' || t.priority === 'דחופה מאוד').length;

      const today = new Date();
      const overdue = activeTasks.filter(t => {
        if (!t.dueDate) return false;
        return new Date(t.dueDate) < today;
      }).length;

      document.getElementById('statTotal').textContent = activeTasks.length;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statReturned').textContent = returned;
      document.getElementById('statOverdue').textContent = overdue;
      document.getElementById('statUrgent').textContent = urgent;

      // Update tab counts
      document.getElementById('tabActiveCount').textContent = activeTasks.length;
      document.getElementById('tabCompletedCount').textContent = completed;

      updateAttentionBanner(activeTasks);
    }

    function updateAttentionBanner(visibleTasks) {
      const banner = document.getElementById('attentionBanner');
      const itemsEl = document.getElementById('attentionItems');
      const today = new Date();
      const items = [];

      const overdueTasks = visibleTasks.filter(t => {
        if (!t.dueDate || t.status === 'בוצע' || t.status === 'בוטל') return false;
        return new Date(t.dueDate) < today;
      });
      const returnedTasks = visibleTasks.filter(t => t.status === 'הוחזר להשלמה');
      const criticalTasks = visibleTasks.filter(t =>
        t.priority === 'דחופה מאוד' && t.status !== 'בוצע' && t.status !== 'בוטל'
      );

      if (overdueTasks.length > 0) {
        items.push('<button class="attention-item overdue-item" onclick="filterByOverdue()"><i class="fas fa-clock"></i> משימות באיחור <span class="attention-item-count">' + overdueTasks.length + '</span></button>');
      }
      if (returnedTasks.length > 0) {
        items.push('<button class="attention-item returned-item" onclick="filterByStatus(\'הוחזר להשלמה\')"><i class="fas fa-undo"></i> ממתינות לתשובה <span class="attention-item-count">' + returnedTasks.length + '</span></button>');
      }
      if (criticalTasks.length > 0) {
        items.push('<button class="attention-item urgent-item" onclick="filterByUrgent()"><i class="fas fa-exclamation-triangle"></i> דחופות מאוד <span class="attention-item-count">' + criticalTasks.length + '</span></button>');
      }

      if (items.length > 0) {
        itemsEl.innerHTML = items.join('');
        banner.classList.add('show');
      } else {
        banner.classList.remove('show');
      }
    }

    // ============================================
    // Filters
    // ============================================
    function applyFilters() {
      const userFilter = document.getElementById('userFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const today = new Date();

      filteredTasks = allTasks.filter(task => {
        // Date filter - default from 2026-01-01
        if (dateFromFilter) {
          const taskDate = new Date(task.date);
          const fromDate = new Date(dateFromFilter);
          if (!isNaN(taskDate.getTime()) && !isNaN(fromDate.getTime()) && taskDate < fromDate) return false;
        }

        // Status tab filter: active vs completed
        const isCompleted = task.status === 'בוצע' || task.status === 'בוטל';
        if (currentStatusTab === 'active' && isCompleted) return false;
        if (currentStatusTab === 'completed' && !isCompleted) return false;

        // Status filter from sidebar counter click
        if (activeStatusFilter && task.status !== activeStatusFilter) return false;

        // Special filters
        if (specialFilter === 'overdue') {
          if (!task.dueDate || task.status === 'בוצע' || task.status === 'בוטל') return false;
          if (new Date(task.dueDate) >= today) return false;
        }
        if (specialFilter === 'urgent') {
          if (task.priority !== 'דחופה' && task.priority !== 'דחופה מאוד') return false;
        }

        // Dropdown filters
        if (userFilter && task.requester !== userFilter) return false;
        if (priorityFilter && task.priority !== priorityFilter) return false;

        // Search
        if (searchQuery) {
          const searchFields = [task.id, String(task.description || ''), task.requester, task.category].join(' ').toLowerCase();
          if (!searchFields.includes(searchQuery)) return false;
        }

        return true;
      });

      // Sort
      if (currentStatusTab === 'completed') {
        // Completed tab: newest first
        filteredTasks.sort((a, b) => {
          const dateA = new Date(a.completionDate || a.date);
          const dateB = new Date(b.completionDate || b.date);
          return dateB - dateA;
        });
      } else {
        // Active tab: priority first, then newest
        const priorityOrder = { 'דחופה מאוד': 0, 'דחופה': 1, 'רגילה': 2 };
        filteredTasks.sort((a, b) => {
          const priA = priorityOrder[a.priority] ?? 2;
          const priB = priorityOrder[b.priority] ?? 2;
          if (priA !== priB) return priA - priB;

          const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
          const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
          return dateB - dateA;
        });
      }

      document.getElementById('taskCountLabel').textContent = filteredTasks.length + ' משימות';
      renderCards();
      renderTable();
      if (currentView === 'avatars') renderAvatars();
    }

    function clearFilters() {
      document.getElementById('userFilter').value = '';
      document.getElementById('priorityFilter').value = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('dateFromFilter').value = '2026-01-01';
      dateFromFilter = '2026-01-01';
      activeStatusFilter = '';
      specialFilter = '';
      currentStatusTab = 'active';
      document.getElementById('tabActive').classList.add('active');
      document.getElementById('tabCompleted').classList.remove('active');
      document.querySelectorAll('.stat-counter').forEach(el => el.classList.remove('active'));
      applyFilters();
      showToast('הסינונים נוקו', 'info');
    }

    function showAllTasks() {
      document.getElementById('dateFromFilter').value = '';
      dateFromFilter = '';
      applyFilters();
      showToast('מציג את כל המשימות ללא הגבלת תאריך', 'info');
    }

    // ============================================
    // Render Cards
    // ============================================
    function renderCards() {
      const container = document.getElementById('cardsView');

      if (filteredTasks.length === 0) {
        container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-inbox"></i><p>לא נמצאו משימות</p></div>';
        return;
      }

      container.innerHTML = filteredTasks.map(task => {
        const overdue = isTaskOverdue(task);
        const delayDays = getDelayDays(task);
        const desc = String(task.description || '');
        const descShort = desc.substring(0, 80);
        const statusClass = getCardStatusClass(task, overdue);

        const cardHtml = `
          <div class="task-card ${statusClass}" onclick="viewTaskDetails('${task.id}')">
            <div class="task-card-body">
              <div class="task-card-top">
                <div class="task-card-title-group">
                  <div class="task-card-requester">${task.requester || 'לא ידוע'}</div>
                  <div class="task-card-time">${formatDate(task.date)}</div>
                </div>
                <div class="task-card-priority">${getPriorityBadge(task.priority)}</div>
              </div>
              <div class="task-card-desc">${escapeHtml(descShort)}</div>
            </div>
            <div class="task-card-bottom">
              <div class="task-card-meta">
                ${task.dueDate ? '<span class="task-card-meta-item' + (overdue ? ' overdue-text' : '') + '"><i class="' + (overdue ? 'fas fa-exclamation-circle' : 'far fa-calendar') + '"></i> ' + formatDate(task.dueDate) + (overdue ? ' — באיחור' : '') + '</span>' : ''}
                ${getStatusBadge(task.status)}
              </div>
              <div class="task-card-actions" onclick="event.stopPropagation()">
                ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="card-action-btn-labeled btn-complete" onclick="openCompleteModal(\'' + task.id + '\')"><i class="fas fa-check"></i> בוצע</button>' : ''}
                ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="card-action-btn-labeled btn-return" onclick="openReturnModal(\'' + task.id + '\')"><i class="fas fa-undo"></i> החזר</button>' : ''}
              </div>
            </div>
          </div>`;

        return cardHtml;
      }).join('');
    }

    // ============================================
    // Render Table
    // ============================================
    function renderTable() {
      const tbody = document.getElementById('tasksTableBody');

      if (filteredTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-inbox"></i><p>לא נמצאו משימות</p></td></tr>';
        return;
      }

      tbody.innerHTML = filteredTasks.map(task => {
        const overdue = isTaskOverdue(task);
        const delayDays = getDelayDays(task);
        const desc = String(task.description || '');
        const descShort = desc.substring(0, 50);

        return `
          <tr>
            <td>${formatDate(task.date)}</td>
            <td><strong>${task.requester || 'לא ידוע'}</strong></td>
            <td>
              <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(desc)}">
                ${escapeHtml(descShort)}${desc.length > 50 ? '...' : ''}
              </div>
            </td>
            <td>${getPriorityBadge(task.priority)}</td>
            <td>${overdue ? '<span class="overdue-indicator">' + formatDate(task.dueDate) + ' (' + delayDays + ' ימים)</span>' : formatDate(task.dueDate)}</td>
            <td>${getStatusBadge(task.status)}</td>
            <td>
              <div style="display:flex;gap:4px;">
                <button class="btn btn-sm btn-secondary" onclick="viewTaskDetails('${task.id}')" title="פרטים"><i class="fas fa-eye"></i></button>
                ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="btn btn-sm btn-success" onclick="openCompleteModal(\'' + task.id + '\')" title="סמן כבוצע"><i class="fas fa-check"></i></button>' : ''}
                ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="btn btn-sm btn-warning" onclick="openReturnModal(\'' + task.id + '\')" title="החזר למבקש"><i class="fas fa-undo"></i></button>' : ''}
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // ============================================
    // Avatars View
    // ============================================
    function renderAvatars() {
      const grid = document.getElementById('avatarsGrid');

      // Count tasks per user (only filtered tasks respecting date filter)
      const userStats = {};
      USERS.forEach(user => {
        userStats[user] = { active: 0, returned: 0, completed: 0, total: 0 };
      });

      filteredTasks.forEach(task => {
        const user = task.requester;
        if (!userStats[user]) {
          userStats[user] = { active: 0, returned: 0, completed: 0, total: 0 };
        }
        userStats[user].total++;
        if (task.status === 'ממתינה' || task.status === 'בביצוע') {
          userStats[user].active++;
        } else if (task.status === 'הוחזר להשלמה') {
          userStats[user].returned++;
        } else if (task.status === 'בוצע') {
          userStats[user].completed++;
        }
      });

      // Get all users who have tasks + known USERS list
      const allUsers = [...new Set([...USERS, ...Object.keys(userStats)])];

      grid.innerHTML = allUsers.map((user, idx) => {
        const stats = userStats[user] || { active: 0, returned: 0, completed: 0, total: 0 };
        const initial = user.charAt(0);
        const colorClass = 'avatar-color-' + (idx % 12);
        const isActive = selectedAvatarUser === user;
        const noTasks = stats.total === 0;

        return `
          <div class="user-avatar-card ${isActive ? 'active' : ''} ${noTasks ? 'no-tasks' : ''}"
               onclick="selectAvatarUser('${user}')">
            <div class="avatar-circle ${colorClass}">
              ${initial}
              ${stats.active > 0 ? '<span class="avatar-notification">' + stats.active + '</span>' : ''}
              ${stats.returned > 0 ? '<span class="avatar-notification warning">' + stats.returned + '</span>' : ''}
            </div>
            <div class="avatar-name">${user}</div>
            <div class="avatar-badges">
              ${stats.active > 0 ? '<span class="avatar-badge avatar-badge-active"><i class="fas fa-tasks" style="font-size:0.6rem;"></i> ' + stats.active + '</span>' : ''}
              ${stats.returned > 0 ? '<span class="avatar-badge avatar-badge-returned"><i class="fas fa-undo" style="font-size:0.6rem;"></i> ' + stats.returned + '</span>' : ''}
              ${stats.completed > 0 ? '<span class="avatar-badge avatar-badge-completed"><i class="fas fa-check" style="font-size:0.6rem;"></i> ' + stats.completed + '</span>' : ''}
              ${stats.total === 0 ? '<span style="font-size:0.72rem;color:var(--text-muted);">אין משימות</span>' : ''}
            </div>
          </div>`;
      }).join('');

      // If a user is selected, show their tasks below
      if (selectedAvatarUser) {
        renderAvatarTasks(selectedAvatarUser);
      } else {
        document.getElementById('avatarTasksSection').style.display = 'none';
      }
    }

    function selectAvatarUser(user) {
      if (selectedAvatarUser === user) {
        clearAvatarSelection();
        return;
      }
      selectedAvatarUser = user;
      renderAvatars();
    }

    function clearAvatarSelection() {
      selectedAvatarUser = '';
      document.getElementById('avatarTasksSection').style.display = 'none';
      renderAvatars();
    }

    function renderAvatarTasks(user) {
      const section = document.getElementById('avatarTasksSection');
      const titleEl = document.getElementById('avatarTasksTitle');
      const cardsEl = document.getElementById('avatarTasksCards');

      const userIdx = [...new Set([...USERS, ...Object.keys({})])].indexOf(user);
      const colorIdx = USERS.indexOf(user) >= 0 ? USERS.indexOf(user) : 0;
      const initial = user.charAt(0);

      const userTasks = filteredTasks.filter(t => t.requester === user);

      titleEl.innerHTML = `
        <div class="avatar-circle avatar-color-${colorIdx % 12}">${initial}</div>
        <span>${user} (${userTasks.length} משימות)</span>`;

      if (userTasks.length === 0) {
        cardsEl.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-inbox"></i><p>אין משימות פעילות</p></div>';
      } else {
        cardsEl.innerHTML = userTasks.map(task => {
          const overdue = isTaskOverdue(task);
          const delayDays = getDelayDays(task);
          const desc = String(task.description || '');
          const descShort = desc.substring(0, 80);
          const statusClass = getCardStatusClass(task, overdue);

          const cardHtml = `
            <div class="task-card ${statusClass}" onclick="viewTaskDetails('${task.id}')">
              <div class="task-card-body">
                <div class="task-card-top">
                  <div class="task-card-title-group">
                    <div class="task-card-requester">${task.requester || 'לא ידוע'}</div>
                    <div class="task-card-time">${formatDate(task.date)}</div>
                  </div>
                  <div class="task-card-priority">${getPriorityBadge(task.priority)}</div>
                </div>
                <div class="task-card-desc">${escapeHtml(descShort)}</div>
              </div>
              <div class="task-card-bottom">
                <div class="task-card-meta">
                  ${task.dueDate ? '<span class="task-card-meta-item' + (overdue ? ' overdue-text' : '') + '"><i class="' + (overdue ? 'fas fa-exclamation-circle' : 'far fa-calendar') + '"></i> ' + formatDate(task.dueDate) + (overdue ? ' — באיחור' : '') + '</span>' : ''}
                  ${getStatusBadge(task.status)}
                </div>
                <div class="task-card-actions" onclick="event.stopPropagation()">
                  ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="card-action-btn-labeled btn-complete" onclick="openCompleteModal(\'' + task.id + '\')"><i class="fas fa-check"></i> בוצע</button>' : ''}
                  ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="card-action-btn-labeled btn-return" onclick="openReturnModal(\'' + task.id + '\')"><i class="fas fa-undo"></i> החזר</button>' : ''}
                </div>
              </div>
            </div>`;

          return cardHtml;
        }).join('');
      }

      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ============================================
    // Helper Functions
    // ============================================
    function getCardStatusClass(task, overdue) {
      if (overdue) return 'task-card-overdue';
      const map = { 'ממתינה': 'status-pending', 'בביצוע': 'status-in-progress', 'בוצע': 'status-completed', 'הוחזר להשלמה': 'status-returned', 'בוטל': 'status-cancelled' };
      return map[task.status] || 'status-pending';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) { return dateStr; }
    }

    function getStatusBadge(status) {
      const map = { 'ממתינה': 'pending', 'בביצוע': 'in-progress', 'בוצע': 'completed', 'הוחזר להשלמה': 'returned', 'בוטל': 'cancelled' };
      const cls = map[status] || 'pending';
      return '<span class="status-badge ' + cls + '">' + (status || 'ממתינה') + '</span>';
    }

    function getPriorityBadge(priority) {
      const map = { 'רגילה': 'normal', 'דחופה': 'urgent', 'דחופה מאוד': 'critical' };
      const cls = map[priority] || 'normal';
      if (cls === 'normal') return '<span class="priority-badge normal">' + (priority || 'רגילה') + '</span>';
      return '<span class="priority-badge ' + cls + '">' + (priority || 'רגילה') + '</span>';
    }

    function isTaskOverdue(task) {
      if (!task.dueDate || task.status === 'בוצע' || task.status === 'בוטל') return false;
      return new Date(task.dueDate) < new Date();
    }

    function getDelayDays(task) {
      if (!isTaskOverdue(task)) return 0;
      return Math.ceil((new Date() - new Date(task.dueDate)) / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // Modal Functions
    // ============================================
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function viewTaskDetails(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const body = document.getElementById('taskDetailBody');
      const taskEmail = task.requesterEmail || task.email || '';
      body.innerHTML = `
        <div class="task-detail-row"><div class="task-detail-label">מבקש:</div><div class="task-detail-value">${task.requester || '-'}</div></div>
        ${taskEmail ? '<div class="task-detail-row"><div class="task-detail-label">אימייל:</div><div class="task-detail-value"><a href="mailto:' + escapeHtml(taskEmail) + '">' + escapeHtml(taskEmail) + '</a></div></div>' : ''}
        <div class="task-detail-row"><div class="task-detail-label">קטגוריה:</div><div class="task-detail-value">${task.category || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">דחיפות:</div><div class="task-detail-value">${getPriorityBadge(task.priority)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יעד:</div><div class="task-detail-value">${formatDate(task.dueDate)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">סטטוס:</div><div class="task-detail-value">${getStatusBadge(task.status)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יצירה:</div><div class="task-detail-value">${formatDate(task.date)} ${task.time || ''}</div></div>
        ${task.completionDate ? '<div class="task-detail-row"><div class="task-detail-label">תאריך השלמה:</div><div class="task-detail-value">' + formatDate(task.completionDate) + '</div></div>' : ''}
        ${task.completionDetails ? '<div class="task-detail-row"><div class="task-detail-label">פרטי ביצוע:</div><div class="task-detail-value">' + escapeHtml(task.completionDetails) + '</div></div>' : ''}
        ${task.attachments ? '<div class="task-detail-row"><div class="task-detail-label">קבצים:</div><div class="task-detail-value"><a href="' + task.attachments + '" target="_blank" rel="noopener">צפה בקבצים</a></div></div>' : ''}
        <div style="margin-top:14px;">
          <div class="form-label">תיאור המשימה:</div>
          <div style="background:var(--bg-primary);padding:12px;border-radius:var(--radius-md);line-height:1.6;white-space:pre-wrap;font-size:0.85rem;">${escapeHtml(String(task.description || '-'))}</div>
        </div>
        ${task.secretaryNotes ? '<div style="margin-top:12px;"><div class="form-label">הערות מזכירה:</div><div style="background:#fff3cd;padding:12px;border-radius:var(--radius-md);line-height:1.6;font-size:0.85rem;">' + escapeHtml(task.secretaryNotes) + '</div></div>' : ''}
        <div class="modal-actions">
          ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="btn btn-success" onclick="closeModal(\'taskDetailModal\'); openCompleteModal(\'' + task.id + '\')"><i class="fas fa-check"></i> סמן כבוצע</button>' : ''}
          ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="btn btn-warning" onclick="closeModal(\'taskDetailModal\'); openReturnModal(\'' + task.id + '\')"><i class="fas fa-undo"></i> החזר למבקש</button>' : ''}
          <button class="btn btn-secondary" onclick="closeModal('taskDetailModal')">סגור</button>
        </div>
      `;
      document.getElementById('taskDetailModal').classList.add('active');
    }

    // Mark as completed
    function openCompleteModal(taskId) {
      document.getElementById('completeTaskId').textContent = taskId;
      document.getElementById('completionDetails').value = '';
      document.getElementById('completeModal').classList.add('active');

      document.getElementById('confirmCompleteBtn').onclick = function() {
        const details = document.getElementById('completionDetails').value.trim();
        if (!details) {
          showToast('חובה להזין פרטי ביצוע', 'warning');
          document.getElementById('completionDetails').focus();
          return;
        }
        closeModal('completeModal');
        markAsCompleted(taskId, details);
      };

      setTimeout(() => document.getElementById('completionDetails').focus(), 300);
    }

    async function markAsCompleted(taskId, details) {
      try {
        showToast('מעדכן משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=markTaskCompleted&taskId=${encodeURIComponent(taskId)}&row=${task.row}&details=${encodeURIComponent(details)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה סומנה כבוצעת בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error marking as completed:', error);
        showToast('שגיאה בעדכון המשימה: ' + error.message, 'error');
      }
    }

    // Return task
    function openReturnModal(taskId) {
      document.getElementById('returnTaskId').textContent = taskId;
      document.getElementById('returnReason').value = '';
      document.getElementById('returnModal').classList.add('active');

      document.getElementById('confirmReturnBtn').onclick = function() {
        const reason = document.getElementById('returnReason').value.trim();
        if (!reason) {
          showToast('חובה להזין סיבת החזרה', 'warning');
          document.getElementById('returnReason').focus();
          return;
        }
        closeModal('returnModal');
        returnTask(taskId, reason);
      };

      setTimeout(() => document.getElementById('returnReason').focus(), 300);
    }

    async function returnTask(taskId, reason) {
      try {
        showToast('מחזיר משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=returnTask&taskId=${encodeURIComponent(taskId)}&row=${task.row}&reason=${encodeURIComponent(reason)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה הוחזרה למבקש בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error returning task:', error);
        showToast('שגיאה בהחזרת המשימה: ' + error.message, 'error');
      }
    }

    // Export
    function exportToExcel() {
      if (filteredTasks.length === 0) {
        showToast('אין משימות לייצוא', 'warning');
        return;
      }

      const headers = ['מזהה', 'תאריך', 'מבקש', 'תיאור', 'קטגוריה', 'דחיפות', 'תאריך יעד', 'סטטוס'];
      const csvContent = [
        headers.join(','),
        ...filteredTasks.map(task => [
          task.id || '',
          formatDate(task.date),
          task.requester || '',
          '"' + String(task.description || '').replace(/"/g, '""') + '"',
          task.category || '',
          task.priority || '',
          formatDate(task.dueDate),
          task.status || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'משימות_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showToast('הקובץ הורד בהצלחה', 'success');
    }

    // ============================================
    // Charts
    // ============================================
    function initializeCharts() {
      charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['ממתינה', 'בביצוע', 'בוצע', 'הוחזר', 'בוטל'],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#3b82f6', '#10b981', '#22c55e', '#f59e0b', '#ef4444'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function updateCharts() {
      const statusCounts = { 'ממתינה': 0, 'בביצוע': 0, 'בוצע': 0, 'הוחזר להשלמה': 0, 'בוטל': 0 };
      allTasks.forEach(t => { if (statusCounts.hasOwnProperty(t.status)) statusCounts[t.status]++; });
      charts.status.data.datasets[0].data = Object.values(statusCounts);
      charts.status.update();
    }

    // ============================================
    // UI Helpers
    // ============================================
    function showLoadingState() {
      document.getElementById('cardsView').innerHTML = '<div class="loading-state" style="grid-column:1/-1;"><i class="fas fa-spinner"></i><span>טוען משימות...</span></div>';
      document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="7" class="loading-state"><i class="fas fa-spinner"></i> טוען...</td></tr>';
    }

    function showErrorState() {
      document.getElementById('cardsView').innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-exclamation-triangle"></i><p>שגיאה בטעינת הנתונים</p><button class="btn btn-primary" onclick="loadTasks()" style="margin-top:12px;">נסה שוב</button></div>';
      document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>שגיאה</p></td></tr>';
    }

    let toastTimer;
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      const msgEl = document.getElementById('toastMessage');
      const iconEl = document.getElementById('toastIcon');

      const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
      iconEl.className = 'toast-icon fas ' + (icons[type] || icons.info);
      msgEl.textContent = message;
      toast.className = 'toast ' + (type || 'info') + ' show';

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 4000);
    }
  </script>
</body>
</html>
