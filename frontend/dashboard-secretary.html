<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דשבורד ניהול משימות - משרד עו"ד GH</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="shortcut icon" type="image/png" href="images/favicon.png">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="images/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="images/icon-192.png">

  <!-- Theme Colors -->
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="דשבורד GH">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --secondary-light: #34d399;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --success: #22c55e;

      --bg-primary: #f0f2f5;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;

      --sidebar-width: 280px;
      --topbar-height: 56px;

      --font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      font-family: var(--font-family);
      font-size: 15px;
      line-height: 1.5;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100%;
      -webkit-font-smoothing: antialiased;
    }

    body { display: flex; flex-direction: column; overflow: hidden; }

    /* ========== TOP BAR ========== */
    .topbar {
      height: var(--topbar-height);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .topbar-logo { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.3px; }
    .topbar-subtitle { font-size: 0.8rem; opacity: 0.8; }

    .topbar-left { display: flex; align-items: center; gap: 12px; }

    .topbar-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 6px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-family: var(--font-family);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .topbar-btn:hover { background: rgba(255,255,255,0.25); }

    .topbar-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: color 0.2s;
    }

    .topbar-link:hover { color: white; }

    /* ========== LAYOUT ========== */
    .app-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ========== SIDEBAR (RIGHT) ========== */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-section { }
    .sidebar-section-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-light);
    }

    /* Stat counters in sidebar */
    .stat-counters { display: flex; flex-direction: column; gap: 6px; }

    .stat-counter {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .stat-counter:hover { background: var(--bg-primary); }
    .stat-counter.active { background: var(--bg-primary); border-color: var(--primary); }

    .stat-counter-info { display: flex; align-items: center; gap: 8px; }
    .stat-counter-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .stat-counter-label { font-size: 0.82rem; font-weight: 500; color: var(--text-primary); }
    .stat-counter-value {
      font-size: 0.9rem;
      font-weight: 700;
      min-width: 28px;
      text-align: center;
      padding: 2px 8px;
      border-radius: 12px;
      background: var(--bg-primary);
    }

    .dot-total { background: var(--primary); }
    .dot-pending { background: #3b82f6; }
    .dot-in-progress { background: #10b981; }
    .dot-completed { background: #22c55e; }
    .dot-returned { background: #f59e0b; }
    .dot-cancelled { background: #ef4444; }
    .dot-overdue { background: #ef4444; }
    .dot-urgent { background: #f59e0b; }

    /* Filter dropdowns in sidebar */
    .sidebar-filter { display: flex; flex-direction: column; gap: 8px; }

    .filter-select {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.82rem;
      background: var(--bg-secondary);
      font-family: var(--font-family);
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .filter-select:focus { outline: none; border-color: var(--primary); }

    .sidebar-search {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.82rem;
      background: var(--bg-secondary);
      font-family: var(--font-family);
      transition: border-color 0.2s;
    }

    .sidebar-search:focus { outline: none; border-color: var(--primary); }

    .sidebar-btn {
      width: 100%;
      padding: 7px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font-family);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .sidebar-btn-clear { background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border); }
    .sidebar-btn-clear:hover { background: var(--border); }

    .sidebar-btn-export { background: var(--success); color: white; }
    .sidebar-btn-export:hover { background: #16a34a; }

    /* Mini chart in sidebar */
    .sidebar-chart { height: 160px; position: relative; }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Main header row */
    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .main-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
    .task-count { font-size: 0.85rem; color: var(--text-muted); font-weight: 400; }

    .view-toggle { display: flex; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }

    .view-toggle-btn {
      padding: 6px 14px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.82rem;
      font-family: var(--font-family);
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .view-toggle-btn.active { background: var(--primary); color: white; }
    .view-toggle-btn:not(.active):hover { background: var(--bg-primary); }

    /* ========== CARD VIEW ========== */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .task-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      border: 1px solid var(--border);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      cursor: pointer;
    }

    .task-card:hover { box-shadow: var(--shadow-md); border-color: var(--primary-light); }

    .task-card-overdue { border-right: 3px solid var(--danger); }

    .task-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .task-card-requester {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-card-requester i { color: var(--primary); font-size: 0.75rem; }

    .task-card-priority { flex-shrink: 0; }

    .task-card-desc {
      font-size: 0.82rem;
      color: var(--text-secondary);
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .task-card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: auto;
    }

    .task-card-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .task-card-meta-item { display: flex; align-items: center; gap: 4px; }
    .task-card-meta-item.overdue-text { color: var(--danger); font-weight: 600; }

    .task-card-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .card-action-btn {
      width: 30px;
      height: 30px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .card-action-btn:hover { border-color: var(--primary); color: var(--primary); }
    .card-action-btn.btn-complete { color: var(--success); }
    .card-action-btn.btn-complete:hover { background: var(--success); color: white; border-color: var(--success); }
    .card-action-btn.btn-return { color: var(--warning); }
    .card-action-btn.btn-return:hover { background: var(--warning); color: white; border-color: var(--warning); }

    /* ========== TABLE VIEW ========== */
    .table-container { overflow-x: auto; background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); }

    .tasks-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }

    .tasks-table th {
      background: var(--bg-primary);
      padding: 10px 12px;
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 0.8rem;
    }

    .tasks-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .tasks-table tr:hover { background: var(--bg-primary); }

    /* ========== BADGES ========== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-size: 0.7rem;
      font-weight: 500;
      border-radius: 10px;
    }

    .status-badge.pending { background: rgb(59 130 246 / 0.1); color: #2563eb; }
    .status-badge.in-progress { background: rgb(16 185 129 / 0.1); color: #059669; }
    .status-badge.completed { background: rgb(34 197 94 / 0.1); color: #16a34a; }
    .status-badge.returned { background: rgb(245 158 11 / 0.1); color: #d97706; }
    .status-badge.cancelled { background: rgb(239 68 68 / 0.1); color: #dc2626; }

    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 7px;
      font-size: 0.68rem;
      font-weight: 600;
      border-radius: 10px;
    }

    .priority-badge.normal { background: rgb(148 163 184 / 0.1); color: var(--text-muted); }
    .priority-badge.urgent { background: rgb(245 158 11 / 0.15); color: #b45309; }
    .priority-badge.critical { background: rgb(239 68 68 / 0.15); color: #dc2626; }

    .overdue-indicator { color: var(--danger); font-weight: 600; font-size: 0.8rem; }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 16px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-dialog {
      width: 100%;
      max-width: 480px;
      background-color: white;
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s;
    }

    .modal-overlay.active .modal-dialog { transform: translateY(0); opacity: 1; }

    .modal-header {
      padding: 14px 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-header.success-header { background: linear-gradient(135deg, #22c55e, #10b981); }
    .modal-header.warning-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .modal-header.info-header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }

    .modal-title { font-size: 1rem; font-weight: 600; }

    .modal-body { padding: 20px; }
    .modal-body .form-group { margin-bottom: 16px; }
    .modal-body .form-label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); font-size: 0.85rem; }

    .modal-body .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      font-family: var(--font-family);
      transition: all 0.2s;
    }

    .modal-body .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1); }
    .modal-body textarea.form-input { min-height: 90px; resize: vertical; line-height: 1.5; }

    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

    .task-detail-row { display: flex; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-light); }
    .task-detail-label { font-weight: 600; color: var(--text-secondary); min-width: 90px; font-size: 0.82rem; }
    .task-detail-value { color: var(--text-primary); font-size: 0.82rem; flex: 1; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 16px;
      font-size: 0.82rem;
      font-weight: 500;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
      font-family: var(--font-family);
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-primary); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 4px 8px; font-size: 0.75rem; }

    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 10px 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      z-index: 99999;
      min-width: 280px;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .toast.success { border-right: 4px solid var(--success); }
    .toast.error { border-right: 4px solid var(--danger); }
    .toast.warning { border-right: 4px solid var(--warning); }
    .toast.info { border-right: 4px solid var(--info); }

    .toast-icon { font-size: 1.1rem; }
    .toast.success .toast-icon { color: var(--success); }
    .toast.error .toast-icon { color: var(--danger); }
    .toast.warning .toast-icon { color: var(--warning); }
    .toast.info .toast-icon { color: var(--info); }

    /* ========== LOADING & EMPTY ========== */
    .loading-state {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px 20px;
      color: var(--text-muted);
      gap: 12px;
    }

    .loading-state i { font-size: 1.5rem; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.4; display: block; }

    /* ========== MOBILE SIDEBAR TOGGLE ========== */
    .sidebar-toggle-mobile {
      display: none;
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      font-size: 1.1rem;
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        top: var(--topbar-height);
        right: -300px;
        height: calc(100% - var(--topbar-height));
        z-index: 150;
        box-shadow: -4px 0 20px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
      }

      .sidebar.open { right: 0; }

      .sidebar-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 140;
        display: none;
      }

      .sidebar-overlay.show { display: block; }

      .sidebar-toggle-mobile { display: flex; }

      .cards-container { grid-template-columns: 1fr; }
    }

    @media (max-width: 600px) {
      .topbar { padding: 0 12px; }
      .topbar-subtitle { display: none; }
      .main-content { padding: 12px; }
      .task-card { padding: 12px; }
    }

    /* Hide view based on toggle */
    .view-hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-right">
      <div>
        <div class="topbar-logo">דשבורד משימות</div>
        <div class="topbar-subtitle">משרד עו"ד GH</div>
      </div>
    </div>
    <div class="topbar-left">
      <a href="index.html" class="topbar-link"><i class="fas fa-plus-circle"></i> שליחת משימה</a>
      <button class="topbar-btn" onclick="loadTasks()" title="רענן נתונים"><i class="fas fa-sync-alt"></i> רענן</button>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="app-layout">
    <!-- SIDEBAR (right) -->
    <aside class="sidebar" id="sidebar">
      <!-- Statistics Counters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">סטטיסטיקות</div>
        <div class="stat-counters">
          <div class="stat-counter" data-filter-status="" onclick="filterByStatus('')" id="counterAll">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-total"></span>
              <span class="stat-counter-label">סה"כ משימות</span>
            </div>
            <span class="stat-counter-value" id="statTotal">0</span>
          </div>
          <div class="stat-counter" data-filter-status="ממתינה" onclick="filterByStatus('ממתינה')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-pending"></span>
              <span class="stat-counter-label">ממתינות</span>
            </div>
            <span class="stat-counter-value" id="statPending">0</span>
          </div>
          <div class="stat-counter" data-filter-status="בביצוע" onclick="filterByStatus('בביצוע')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-in-progress"></span>
              <span class="stat-counter-label">בביצוע</span>
            </div>
            <span class="stat-counter-value" id="statInProgress">0</span>
          </div>
          <div class="stat-counter" data-filter-status="בוצע" onclick="filterByStatus('בוצע')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-completed"></span>
              <span class="stat-counter-label">הושלמו</span>
            </div>
            <span class="stat-counter-value" id="statCompleted">0</span>
          </div>
          <div class="stat-counter" data-filter-status="הוחזר להשלמה" onclick="filterByStatus('הוחזר להשלמה')">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-returned"></span>
              <span class="stat-counter-label">הוחזרו</span>
            </div>
            <span class="stat-counter-value" id="statReturned">0</span>
          </div>
          <div class="stat-counter" data-filter-status="overdue" onclick="filterByOverdue()">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-overdue"></span>
              <span class="stat-counter-label">באיחור</span>
            </div>
            <span class="stat-counter-value" id="statOverdue">0</span>
          </div>
          <div class="stat-counter" data-filter-status="urgent" onclick="filterByUrgent()">
            <div class="stat-counter-info">
              <span class="stat-counter-dot dot-urgent"></span>
              <span class="stat-counter-label">דחופות</span>
            </div>
            <span class="stat-counter-value" id="statUrgent">0</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">סינון</div>
        <div class="sidebar-filter">
          <input type="text" class="sidebar-search" id="searchInput" placeholder="&#xf002;  חיפוש חופשי..." style="font-family: 'Font Awesome 6 Free', var(--font-family);">
          <select class="filter-select" id="userFilter">
            <option value="">כל המשתמשים</option>
          </select>
          <select class="filter-select" id="priorityFilter">
            <option value="">כל הדחיפויות</option>
            <option value="רגילה">רגילה</option>
            <option value="דחופה">דחופה</option>
            <option value="דחופה מאוד">דחופה מאוד</option>
          </select>
          <button class="sidebar-btn sidebar-btn-clear" onclick="clearFilters()"><i class="fas fa-times"></i> נקה סינונים</button>
        </div>
      </div>

      <!-- Chart -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">התפלגות סטטוס</div>
        <div class="sidebar-chart">
          <canvas id="statusChart"></canvas>
        </div>
      </div>

      <!-- Export -->
      <div class="sidebar-section" style="margin-top: auto;">
        <button class="sidebar-btn sidebar-btn-export" onclick="exportToExcel()"><i class="fas fa-download"></i> ייצא לאקסל</button>
      </div>
    </aside>

    <!-- MAIN CONTENT (left) -->
    <main class="main-content" id="mainContent">
      <!-- Header row -->
      <div class="main-header">
        <div>
          <span class="main-title">משימות</span>
          <span class="task-count" id="taskCountLabel">0 משימות</span>
        </div>
        <div class="view-toggle">
          <button class="view-toggle-btn active" id="viewCards" onclick="setView('cards')"><i class="fas fa-th-large"></i> כרטיסים</button>
          <button class="view-toggle-btn" id="viewTable" onclick="setView('table')"><i class="fas fa-list"></i> טבלה</button>
        </div>
      </div>

      <!-- Cards View -->
      <div class="cards-container" id="cardsView"></div>

      <!-- Table View -->
      <div class="table-container view-hidden" id="tableView">
        <table class="tasks-table">
          <thead>
            <tr>
              <th>מזהה</th>
              <th>תאריך</th>
              <th>מבקש</th>
              <th>תיאור</th>
              <th>דחיפות</th>
              <th>תאריך יעד</th>
              <th>סטטוס</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Mobile sidebar toggle -->
  <button class="sidebar-toggle-mobile" id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-filter"></i></button>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="toast-icon fas fa-info-circle" id="toastIcon"></i>
    <div id="toastMessage"></div>
  </div>

  <!-- Modal: פרטי משימה -->
  <div class="modal-overlay" id="taskDetailModal">
    <div class="modal-dialog" style="max-width: 520px;">
      <div class="modal-header info-header">
        <i class="fas fa-info-circle"></i>
        <div class="modal-title">פרטי משימה</div>
      </div>
      <div class="modal-body" id="taskDetailBody"></div>
    </div>
  </div>

  <!-- Modal: סימון כבוצע -->
  <div class="modal-overlay" id="completeModal">
    <div class="modal-dialog">
      <div class="modal-header success-header">
        <i class="fas fa-check-circle"></i>
        <div class="modal-title">סימון משימה כבוצעה</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 12px; color: var(--text-secondary);">
          משימה: <strong id="completeTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">פרטי ביצוע (חובה)</label>
          <textarea class="form-input" id="completionDetails" placeholder="תאר מה בוצע ואיך..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('completeModal')">ביטול</button>
          <button class="btn btn-success" id="confirmCompleteBtn"><i class="fas fa-check"></i> סמן כבוצע</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: החזרת משימה -->
  <div class="modal-overlay" id="returnModal">
    <div class="modal-dialog">
      <div class="modal-header warning-header">
        <i class="fas fa-undo"></i>
        <div class="modal-title">החזרת משימה למבקש</div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 12px; color: var(--text-secondary);">
          משימה: <strong id="returnTaskId"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">סיבת ההחזרה (חובה)</label>
          <textarea class="form-input" id="returnReason" placeholder="מה חסר או לא ברור? מה המבקש צריך להשלים?"></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('returnModal')">ביטול</button>
          <button class="btn btn-warning" id="confirmReturnBtn"><i class="fas fa-undo"></i> החזר למבקש</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: דוח איחורים -->
  <div class="modal-overlay" id="overdueModal">
    <div class="modal-dialog" style="max-width: 600px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="modal-title">דוח משימות באיחור</div>
      </div>
      <div class="modal-body" id="overdueBody"></div>
    </div>
  </div>

  <script>
    // ============================================
    // Google Apps Script URL
    // ============================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4_TYPbCtA8KPKdANLBCFLDWyIIiBQMTzq6c02SyI9ZT7Xg2nMFUF3fV3msBecr8cI/exec';

    let allTasks = [];
    let filteredTasks = [];
    let currentView = 'cards';
    let activeStatusFilter = '';
    let specialFilter = ''; // 'overdue' or 'urgent'
    let charts = {};

    const USERS = [
      'חיים', 'גיא', 'רועי', 'שחר', 'עוזי', 'אורי', 'ראיד', 'מרווה', 'מירי', 'שני', 'נטליה', 'מריה'
    ];

    // ============================================
    // Init
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
      loadTasks();
      setupEventListeners();
      initializeCharts();
    });

    function initializePage() {
      const userFilter = document.getElementById('userFilter');
      USERS.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        userFilter.appendChild(option);
      });

      setInterval(loadTasks, 300000);
    }

    function setupEventListeners() {
      document.getElementById('userFilter').addEventListener('change', applyFilters);
      document.getElementById('priorityFilter').addEventListener('change', applyFilters);
      document.getElementById('searchInput').addEventListener('input', applyFilters);

      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) this.classList.remove('active');
        });
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
      });
    }

    // ============================================
    // Sidebar filter by status counter click
    // ============================================
    function filterByStatus(status) {
      specialFilter = '';
      activeStatusFilter = status;
      highlightActiveCounter(status);
      applyFilters();
    }

    function filterByOverdue() {
      activeStatusFilter = '';
      specialFilter = 'overdue';
      highlightActiveCounter('overdue');
      applyFilters();
    }

    function filterByUrgent() {
      activeStatusFilter = '';
      specialFilter = 'urgent';
      highlightActiveCounter('urgent');
      applyFilters();
    }

    function highlightActiveCounter(status) {
      document.querySelectorAll('.stat-counter').forEach(el => el.classList.remove('active'));
      const selector = status === 'overdue' || status === 'urgent'
        ? `.stat-counter[data-filter-status="${status}"]`
        : `.stat-counter[data-filter-status="${status}"]`;
      const el = document.querySelector(selector);
      if (el) el.classList.add('active');
    }

    // ============================================
    // View toggle
    // ============================================
    function setView(view) {
      currentView = view;
      document.getElementById('viewCards').classList.toggle('active', view === 'cards');
      document.getElementById('viewTable').classList.toggle('active', view === 'table');
      document.getElementById('cardsView').classList.toggle('view-hidden', view !== 'cards');
      document.getElementById('tableView').classList.toggle('view-hidden', view !== 'table');
    }

    // ============================================
    // Mobile sidebar
    // ============================================
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('show');
    }

    // ============================================
    // Load Tasks
    // ============================================
    async function loadTasks() {
      try {
        showLoadingState();

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=getAllTasks'
        });

        const data = await response.json();

        if (data.status === 'success') {
          allTasks = data.tasks || [];
          updateStatistics();
          applyFilters();
          updateCharts();
          showToast('הנתונים עודכנו בהצלחה', 'success');
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        showToast('שגיאה בטעינת הנתונים: ' + error.message, 'error');
        showErrorState();
      }
    }

    // ============================================
    // Statistics (sidebar counters)
    // ============================================
    function updateStatistics() {
      const total = allTasks.length;
      const pending = allTasks.filter(t => t.status === 'ממתינה').length;
      const inProgress = allTasks.filter(t => t.status === 'בביצוע').length;
      const completed = allTasks.filter(t => t.status === 'בוצע').length;
      const returned = allTasks.filter(t => t.status === 'הוחזר להשלמה').length;
      const urgent = allTasks.filter(t => t.priority === 'דחופה' || t.priority === 'דחופה מאוד').length;

      const today = new Date();
      const overdue = allTasks.filter(t => {
        if (!t.dueDate || t.status === 'בוצע' || t.status === 'בוטל') return false;
        return new Date(t.dueDate) < today;
      }).length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statReturned').textContent = returned;
      document.getElementById('statOverdue').textContent = overdue;
      document.getElementById('statUrgent').textContent = urgent;
    }

    // ============================================
    // Filters
    // ============================================
    function applyFilters() {
      const userFilter = document.getElementById('userFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const today = new Date();

      filteredTasks = allTasks.filter(task => {
        // Status filter from sidebar counter click
        if (activeStatusFilter && task.status !== activeStatusFilter) return false;

        // Special filters
        if (specialFilter === 'overdue') {
          if (!task.dueDate || task.status === 'בוצע' || task.status === 'בוטל') return false;
          if (new Date(task.dueDate) >= today) return false;
        }
        if (specialFilter === 'urgent') {
          if (task.priority !== 'דחופה' && task.priority !== 'דחופה מאוד') return false;
        }

        // Dropdown filters
        if (userFilter && task.requester !== userFilter) return false;
        if (priorityFilter && task.priority !== priorityFilter) return false;

        // Search
        if (searchQuery) {
          const searchFields = [task.id, String(task.description || ''), task.requester, task.category].join(' ').toLowerCase();
          if (!searchFields.includes(searchQuery)) return false;
        }

        return true;
      });

      // Sort: newest first
      filteredTasks.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
        const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
        return dateB - dateA;
      });

      document.getElementById('taskCountLabel').textContent = filteredTasks.length + ' משימות';
      renderCards();
      renderTable();
    }

    function clearFilters() {
      document.getElementById('userFilter').value = '';
      document.getElementById('priorityFilter').value = '';
      document.getElementById('searchInput').value = '';
      activeStatusFilter = '';
      specialFilter = '';
      document.querySelectorAll('.stat-counter').forEach(el => el.classList.remove('active'));
      applyFilters();
      showToast('הסינונים נוקו', 'info');
    }

    // ============================================
    // Render Cards
    // ============================================
    function renderCards() {
      const container = document.getElementById('cardsView');

      if (filteredTasks.length === 0) {
        container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-inbox"></i><p>לא נמצאו משימות</p></div>';
        return;
      }

      container.innerHTML = filteredTasks.map(task => {
        const overdue = isTaskOverdue(task);
        const delayDays = getDelayDays(task);
        const desc = String(task.description || '');
        const descShort = desc.substring(0, 80);

        return `
          <div class="task-card ${overdue ? 'task-card-overdue' : ''}" onclick="viewTaskDetails('${task.id}')">
            <div class="task-card-top">
              <div class="task-card-requester">
                <i class="fas fa-user"></i>
                ${task.requester || 'לא ידוע'}
              </div>
              <div class="task-card-priority">${getPriorityBadge(task.priority)}</div>
            </div>
            <div class="task-card-desc">${escapeHtml(descShort)}</div>
            <div class="task-card-bottom">
              <div class="task-card-meta">
                ${getStatusBadge(task.status)}
                ${task.dueDate ? '<span class="task-card-meta-item' + (overdue ? ' overdue-text' : '') + '"><i class="fas fa-calendar"></i> ' + formatDate(task.dueDate) + (overdue ? ' (' + delayDays + ' ימים)' : '') + '</span>' : ''}
              </div>
              <div class="task-card-actions" onclick="event.stopPropagation()">
                ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="card-action-btn btn-complete" onclick="openCompleteModal(\'' + task.id + '\')" title="סמן כבוצע"><i class="fas fa-check"></i></button>' : ''}
                ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="card-action-btn btn-return" onclick="openReturnModal(\'' + task.id + '\')" title="החזר למבקש"><i class="fas fa-undo"></i></button>' : ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }

    // ============================================
    // Render Table
    // ============================================
    function renderTable() {
      const tbody = document.getElementById('tasksTableBody');

      if (filteredTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-inbox"></i><p>לא נמצאו משימות</p></td></tr>';
        return;
      }

      tbody.innerHTML = filteredTasks.map(task => {
        const overdue = isTaskOverdue(task);
        const delayDays = getDelayDays(task);
        const desc = String(task.description || '');
        const descShort = desc.substring(0, 50);

        return `
          <tr>
            <td><code style="font-size:0.75rem;">${task.id || 'N/A'}</code></td>
            <td>${formatDate(task.date)}</td>
            <td><strong>${task.requester || 'לא ידוע'}</strong></td>
            <td>
              <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(desc)}">
                ${escapeHtml(descShort)}${desc.length > 50 ? '...' : ''}
              </div>
            </td>
            <td>${getPriorityBadge(task.priority)}</td>
            <td>${overdue ? '<span class="overdue-indicator">' + formatDate(task.dueDate) + ' (' + delayDays + ' ימים)</span>' : formatDate(task.dueDate)}</td>
            <td>${getStatusBadge(task.status)}</td>
            <td>
              <div style="display:flex;gap:4px;">
                <button class="btn btn-sm btn-secondary" onclick="viewTaskDetails('${task.id}')" title="פרטים"><i class="fas fa-eye"></i></button>
                ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="btn btn-sm btn-success" onclick="openCompleteModal(\'' + task.id + '\')" title="סמן כבוצע"><i class="fas fa-check"></i></button>' : ''}
                ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="btn btn-sm btn-warning" onclick="openReturnModal(\'' + task.id + '\')" title="החזר למבקש"><i class="fas fa-undo"></i></button>' : ''}
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // ============================================
    // Helper Functions
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      } catch (e) { return dateStr; }
    }

    function getStatusBadge(status) {
      const map = { 'ממתינה': 'pending', 'בביצוע': 'in-progress', 'בוצע': 'completed', 'הוחזר להשלמה': 'returned', 'בוטל': 'cancelled' };
      const icons = { 'pending': 'clock', 'in-progress': 'play', 'completed': 'check', 'returned': 'undo', 'cancelled': 'times' };
      const cls = map[status] || 'pending';
      return '<span class="status-badge ' + cls + '"><i class="fas fa-' + (icons[cls] || 'clock') + '"></i> ' + (status || 'ממתינה') + '</span>';
    }

    function getPriorityBadge(priority) {
      const map = { 'רגילה': 'normal', 'דחופה': 'urgent', 'דחופה מאוד': 'critical' };
      const icons = { 'normal': 'minus', 'urgent': 'exclamation', 'critical': 'exclamation-triangle' };
      const cls = map[priority] || 'normal';
      return '<span class="priority-badge ' + cls + '"><i class="fas fa-' + (icons[cls] || 'minus') + '"></i> ' + (priority || 'רגילה') + '</span>';
    }

    function isTaskOverdue(task) {
      if (!task.dueDate || task.status === 'בוצע' || task.status === 'בוטל') return false;
      return new Date(task.dueDate) < new Date();
    }

    function getDelayDays(task) {
      if (!isTaskOverdue(task)) return 0;
      return Math.ceil((new Date() - new Date(task.dueDate)) / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // Modal Functions
    // ============================================
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function viewTaskDetails(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const body = document.getElementById('taskDetailBody');
      body.innerHTML = `
        <div class="task-detail-row"><div class="task-detail-label">מזהה:</div><div class="task-detail-value"><code>${task.id}</code></div></div>
        <div class="task-detail-row"><div class="task-detail-label">מבקש:</div><div class="task-detail-value">${task.requester || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">אימייל:</div><div class="task-detail-value">${task.requesterEmail || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">קטגוריה:</div><div class="task-detail-value">${task.category || '-'}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">דחיפות:</div><div class="task-detail-value">${getPriorityBadge(task.priority)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יעד:</div><div class="task-detail-value">${formatDate(task.dueDate)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">סטטוס:</div><div class="task-detail-value">${getStatusBadge(task.status)}</div></div>
        <div class="task-detail-row"><div class="task-detail-label">תאריך יצירה:</div><div class="task-detail-value">${formatDate(task.date)} ${task.time || ''}</div></div>
        ${task.completionDate ? '<div class="task-detail-row"><div class="task-detail-label">תאריך השלמה:</div><div class="task-detail-value">' + formatDate(task.completionDate) + '</div></div>' : ''}
        ${task.completionDetails ? '<div class="task-detail-row"><div class="task-detail-label">פרטי ביצוע:</div><div class="task-detail-value">' + escapeHtml(task.completionDetails) + '</div></div>' : ''}
        ${task.attachments ? '<div class="task-detail-row"><div class="task-detail-label">קבצים:</div><div class="task-detail-value"><a href="' + task.attachments + '" target="_blank" rel="noopener">צפה בקבצים</a></div></div>' : ''}
        <div style="margin-top:14px;">
          <div class="form-label">תיאור המשימה:</div>
          <div style="background:var(--bg-primary);padding:12px;border-radius:var(--radius-md);line-height:1.6;white-space:pre-wrap;font-size:0.85rem;">${escapeHtml(String(task.description || '-'))}</div>
        </div>
        ${task.secretaryNotes ? '<div style="margin-top:12px;"><div class="form-label">הערות מזכירה:</div><div style="background:#fff3cd;padding:12px;border-radius:var(--radius-md);line-height:1.6;font-size:0.85rem;">' + escapeHtml(task.secretaryNotes) + '</div></div>' : ''}
        <div class="modal-actions">
          ${task.status !== 'בוצע' && task.status !== 'בוטל' ? '<button class="btn btn-success" onclick="closeModal(\'taskDetailModal\'); openCompleteModal(\'' + task.id + '\')"><i class="fas fa-check"></i> סמן כבוצע</button>' : ''}
          ${task.status === 'ממתינה' || task.status === 'בביצוע' ? '<button class="btn btn-warning" onclick="closeModal(\'taskDetailModal\'); openReturnModal(\'' + task.id + '\')"><i class="fas fa-undo"></i> החזר למבקש</button>' : ''}
          <button class="btn btn-secondary" onclick="closeModal('taskDetailModal')">סגור</button>
        </div>
      `;
      document.getElementById('taskDetailModal').classList.add('active');
    }

    // Mark as completed
    function openCompleteModal(taskId) {
      document.getElementById('completeTaskId').textContent = taskId;
      document.getElementById('completionDetails').value = '';
      document.getElementById('completeModal').classList.add('active');

      document.getElementById('confirmCompleteBtn').onclick = function() {
        const details = document.getElementById('completionDetails').value.trim();
        if (!details) {
          showToast('חובה להזין פרטי ביצוע', 'warning');
          document.getElementById('completionDetails').focus();
          return;
        }
        closeModal('completeModal');
        markAsCompleted(taskId, details);
      };

      setTimeout(() => document.getElementById('completionDetails').focus(), 300);
    }

    async function markAsCompleted(taskId, details) {
      try {
        showToast('מעדכן משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=markTaskCompleted&taskId=${encodeURIComponent(taskId)}&row=${task.row}&details=${encodeURIComponent(details)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה סומנה כבוצעת בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error marking as completed:', error);
        showToast('שגיאה בעדכון המשימה: ' + error.message, 'error');
      }
    }

    // Return task
    function openReturnModal(taskId) {
      document.getElementById('returnTaskId').textContent = taskId;
      document.getElementById('returnReason').value = '';
      document.getElementById('returnModal').classList.add('active');

      document.getElementById('confirmReturnBtn').onclick = function() {
        const reason = document.getElementById('returnReason').value.trim();
        if (!reason) {
          showToast('חובה להזין סיבת החזרה', 'warning');
          document.getElementById('returnReason').focus();
          return;
        }
        closeModal('returnModal');
        returnTask(taskId, reason);
      };

      setTimeout(() => document.getElementById('returnReason').focus(), 300);
    }

    async function returnTask(taskId, reason) {
      try {
        showToast('מחזיר משימה...', 'info');

        const task = allTasks.find(t => t.id === taskId);
        if (!task) throw new Error('משימה לא נמצאה');

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=returnTask&taskId=${encodeURIComponent(taskId)}&row=${task.row}&reason=${encodeURIComponent(reason)}`
        });

        const data = await response.json();

        if (data.status === 'success') {
          showToast('המשימה הוחזרה למבקש בהצלחה', 'success');
          loadTasks();
        } else {
          throw new Error(data.message || 'שגיאה לא ידועה');
        }
      } catch (error) {
        console.error('Error returning task:', error);
        showToast('שגיאה בהחזרת המשימה: ' + error.message, 'error');
      }
    }

    // Export
    function exportToExcel() {
      if (filteredTasks.length === 0) {
        showToast('אין משימות לייצוא', 'warning');
        return;
      }

      const headers = ['מזהה', 'תאריך', 'מבקש', 'תיאור', 'קטגוריה', 'דחיפות', 'תאריך יעד', 'סטטוס'];
      const csvContent = [
        headers.join(','),
        ...filteredTasks.map(task => [
          task.id || '',
          formatDate(task.date),
          task.requester || '',
          '"' + String(task.description || '').replace(/"/g, '""') + '"',
          task.category || '',
          task.priority || '',
          formatDate(task.dueDate),
          task.status || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'משימות_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showToast('הקובץ הורד בהצלחה', 'success');
    }

    // ============================================
    // Charts
    // ============================================
    function initializeCharts() {
      charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['ממתינה', 'בביצוע', 'בוצע', 'הוחזר', 'בוטל'],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#3b82f6', '#10b981', '#22c55e', '#f59e0b', '#ef4444'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function updateCharts() {
      const statusCounts = { 'ממתינה': 0, 'בביצוע': 0, 'בוצע': 0, 'הוחזר להשלמה': 0, 'בוטל': 0 };
      allTasks.forEach(t => { if (statusCounts.hasOwnProperty(t.status)) statusCounts[t.status]++; });
      charts.status.data.datasets[0].data = Object.values(statusCounts);
      charts.status.update();
    }

    // ============================================
    // UI Helpers
    // ============================================
    function showLoadingState() {
      document.getElementById('cardsView').innerHTML = '<div class="loading-state" style="grid-column:1/-1;"><i class="fas fa-spinner"></i><span>טוען משימות...</span></div>';
      document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="8" class="loading-state"><i class="fas fa-spinner"></i> טוען...</td></tr>';
    }

    function showErrorState() {
      document.getElementById('cardsView').innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="fas fa-exclamation-triangle"></i><p>שגיאה בטעינת הנתונים</p><button class="btn btn-primary" onclick="loadTasks()" style="margin-top:12px;">נסה שוב</button></div>';
      document.getElementById('tasksTableBody').innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>שגיאה</p></td></tr>';
    }

    let toastTimer;
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      const msgEl = document.getElementById('toastMessage');
      const iconEl = document.getElementById('toastIcon');

      const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
      iconEl.className = 'toast-icon fas ' + (icons[type] || icons.info);
      msgEl.textContent = message;
      toast.className = 'toast ' + (type || 'info') + ' show';

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 4000);
    }
  </script>
</body>
</html>
